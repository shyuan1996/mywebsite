<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企業考勤管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .rich-editor-content { min-height: 120px; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem; background: #fff; outline: none; overflow-y: auto; }
        .admin-nav-item.active { background-color: #eff6ff; color: #2563eb; }
        @media (min-width: 768px) { .admin-nav-item.active { border-right: 3px solid #2563eb; } }
        .status-working { background-color: #dbeafe; color: #1e40af; }
        .status-leave { background-color: #f3e8ff; color: #6b21a8; }
        .status-off { background-color: #d1fae5; color: #065f46; }
        .status-absent { background-color: #f3f4f6; color: #4b5563; }
        .status-early { background-color: #fee2e2; color: #991b1b; }
        .badge-general { background-color: #dbeafe; color: #1e40af; }
        .badge-urgent { background-color: #fee2e2; color: #991b1b; }
        .badge-system { background-color: #f3f4f6; color: #1f2937; }
        .btn-disabled { background-color: #9ca3af !important; cursor: not-allowed; opacity: 0.7; }
        input, select, textarea { border: 1px solid #d1d5db !important; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6 !important; ring: 2px; }
    </style>
</head>
<body class="h-screen w-full flex flex-col text-gray-800">

    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 left-5 md:left-auto z-[100] transform transition-all duration-300 translate-x-full opacity-0 pointer-events-none">
        <div id="toast-content" class="bg-white border-l-4 border-blue-500 rounded shadow-lg p-4 flex items-center w-full md:w-auto">
            <div id="toast-icon" class="mr-3 text-blue-500 flex-shrink-0"><i class="fas fa-info-circle"></i></div>
            <div id="toast-message" class="font-medium text-sm break-words">訊息內容</div>
        </div>
    </div>

    <!-- Login -->
    <div id="login-view" class="h-full w-full flex flex-col items-center justify-center p-4 overflow-y-auto bg-gray-100">
        <div class="glass-panel w-full max-w-4xl rounded-2xl flex flex-col md:flex-row overflow-hidden shadow-2xl my-auto">
            <div class="w-full md:w-1/2 p-6 md:p-8 border-b md:border-b-0 md:border-r border-gray-100 bg-white">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-building text-white text-2xl"></i></div>
                    <h1 class="text-2xl font-bold text-gray-800">員工考勤系統</h1>
                </div>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">帳號</label><input class="w-full px-3 py-3 rounded-lg border-gray-300 bg-gray-50 text-base" id="username" type="text" placeholder="請輸入帳號" required></div>
                    <div class="mb-2"><label class="block text-gray-700 text-sm font-bold mb-2">密碼</label><input class="w-full px-3 py-3 rounded-lg border-gray-300 bg-gray-50 text-base" id="password" type="password" placeholder="請輸入密碼" required></div>
                    <div class="flex items-center justify-between mb-6"><label class="flex items-center text-sm text-gray-600 cursor-pointer"><input type="checkbox" id="remember-me" class="mr-2 form-checkbox text-blue-600 rounded"> 記住帳號 (30天免登入)</label></div>
                    <div id="login-error" class="hidden mb-4 p-3 bg-red-50 text-red-600 text-sm rounded border border-red-200 flex items-center"><i class="fas fa-exclamation-triangle mr-2 flex-shrink-0"></i> <span>帳號或密碼輸入錯誤</span></div>
                    <div id="login-inactive-error" class="hidden mb-4 p-3 bg-orange-50 text-orange-600 text-sm rounded border border-orange-200 flex items-center"><i class="fas fa-user-slash mr-2 flex-shrink-0"></i> <span>此帳號已被停用</span></div>
                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 text-base" type="submit">登入系統</button>
                </form>
            </div>
            <div class="w-full md:w-1/2 bg-gray-50 p-6 md:p-8 flex flex-col">
                <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-bullhorn text-orange-500 mr-2"></i> 最新公告</h3>
                <div id="login-announcement-list" class="flex-grow overflow-y-auto custom-scroll space-y-3 pr-2 max-h-[300px] md:max-h-[400px]"></div>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="app-view" class="hidden flex-grow flex flex-col h-full overflow-hidden">
        <header class="bg-white shadow-sm z-10 flex-shrink-0">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0"><i class="fas fa-user"></i></div>
                    <div class="overflow-hidden"><span class="text-gray-500 text-xs block truncate">歡迎回來</span><span class="font-bold text-gray-800 truncate block" id="header-user-name">使用者</span></div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="openChangePasswordModal()" class="flex items-center space-x-1 bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors px-3 py-2 rounded-lg text-sm md:text-base whitespace-nowrap"><i class="fas fa-key"></i><span class="hidden md:inline">修改密碼</span></button>
                    <button onclick="logout()" class="flex items-center space-x-2 bg-red-500 hover:bg-red-600 text-white transition-colors px-3 py-2 rounded-lg shadow-md text-sm md:text-base whitespace-nowrap"><i class="fas fa-sign-out-alt"></i><span class="font-bold hidden md:inline">登出</span></button>
                </div>
            </div>
        </header>

        <!-- Admin Dashboard -->
        <main id="admin-dashboard" class="flex-grow hidden overflow-hidden bg-gray-100 flex flex-col md:flex-row h-full">
            <aside class="w-full md:w-64 bg-white border-b md:border-b-0 md:border-r border-gray-200 flex-shrink-0 flex flex-col h-auto md:h-full z-20 shadow-sm">
                <div class="p-4 md:p-6 border-b border-gray-100 flex justify-between items-center md:block">
                    <div><h2 class="text-lg md:text-xl font-bold text-gray-800">管理控制台</h2><div class="text-xs text-gray-500 mt-1" id="admin-date-full">--</div><div class="text-xl font-mono font-bold text-blue-600 mt-1" id="admin-time-full">--:--:--</div></div>
                </div>
                <nav class="flex-grow p-2 md:p-4 flex flex-row md:flex-col overflow-x-auto md:overflow-visible gap-2 custom-scroll">
                    <button onclick="switchAdminTab('overview')" id="nav-overview" class="admin-nav-item flex-shrink-0 w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition flex items-center active text-sm md:text-base whitespace-nowrap"><i class="fas fa-chart-pie w-6 text-center"></i> <span class="ml-2">員工總覽</span></button>
                    <button onclick="switchAdminTab('leaves')" id="nav-leaves" class="admin-nav-item flex-shrink-0 w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition flex items-center justify-between text-sm md:text-base whitespace-nowrap"><div class="flex items-center"><i class="fas fa-tasks w-6 text-center"></i> <span class="ml-2">請假審核</span></div><span id="admin-sidebar-pending-count" class="bg-orange-100 text-orange-600 text-xs px-2 py-0.5 rounded-full hidden ml-1">0</span></button>
                    <button onclick="switchAdminTab('announcements')" id="nav-announcements" class="admin-nav-item flex-shrink-0 w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition flex items-center text-sm md:text-base whitespace-nowrap"><i class="fas fa-bullhorn w-6 text-center"></i> <span class="ml-2">公告管理</span></button>
                    <button onclick="switchAdminTab('holidays')" id="nav-holidays" class="admin-nav-item flex-shrink-0 w-auto md:w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition flex items-center text-sm md:text-base whitespace-nowrap"><i class="fas fa-umbrella-beach w-6 text-center"></i> <span class="ml-2">假期設定</span></button>
                </nav>
            </aside>
            <div class="flex-1 w-full min-w-0 overflow-y-auto p-4 md:p-8 custom-scroll h-full">
                <!-- Overview -->
                <div id="admin-view-overview" class="admin-view space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3 border-b pb-2">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800">員工考勤總覽 (今日)</h3>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button onclick="openExportModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm shadow flex-1 sm:flex-none whitespace-nowrap"><i class="fas fa-file-export mr-1"></i> 匯出明細</button>
                            <button onclick="toggleDeletedUsers()" id="btn-toggle-deleted" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm shadow flex-1 sm:flex-none whitespace-nowrap"><i class="fas fa-trash-restore mr-1"></i> 查看已刪除</button>
                            <button onclick="openAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow flex-1 sm:flex-none whitespace-nowrap"><i class="fas fa-user-plus mr-1"></i> 新增員工</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                        <div class="overflow-x-auto"><table class="w-full text-left border-collapse min-w-[800px]"><thead class="bg-gray-50"><tr class="text-gray-500 text-sm border-b"><th class="p-4 whitespace-nowrap">員工帳號</th><th class="p-4 whitespace-nowrap">員工姓名</th><th class="p-4 whitespace-nowrap">部門</th><th class="p-4 whitespace-nowrap">上班時間 (最早)</th><th class="p-4 whitespace-nowrap">下班時間 (最晚)</th><th class="p-4 whitespace-nowrap">今日狀態</th><th class="p-4 whitespace-nowrap">操作</th></tr></thead><tbody id="admin-records-body" class="text-sm divide-y divide-gray-100 bg-white"></tbody></table></div>
                    </div>
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 lg:p-6 rounded-xl border border-indigo-100">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 gap-2"><h4 class="font-bold text-indigo-800 flex items-center"><i class="fas fa-robot mr-2"></i> 每日 AI 人事報告</h4><button onclick="generateAIReport()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm transition w-full sm:w-auto">立即生成報告</button></div>
                        <div id="ai-report-content" class="bg-white p-4 rounded border border-indigo-100 text-sm text-gray-700 min-h-[80px]">請點擊上方按鈕生成今日考勤摘要。</div>
                    </div>
                </div>
                <!-- Leaves -->
                <div id="admin-view-leaves" class="admin-view hidden space-y-6">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-2">請假申請審核</h3>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-l-4 border-orange-500 pl-2 gap-2">
                            <h4 class="font-bold text-gray-700">待審核列表</h4>
                            <div class="flex space-x-2"><button onclick="changeAdminPage(-1)" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 text-xs"><i class="fas fa-chevron-left"></i></button><span id="admin-page-indicator" class="text-xs self-center">1 / 1</span><button onclick="changeAdminPage(1)" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 text-xs"><i class="fas fa-chevron-right"></i></button></div>
                        </div>
                        <div class="space-y-4 max-h-[500px] overflow-y-auto custom-scroll" id="admin-pending-list"></div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-l-4 border-gray-500 pl-2 gap-3">
                            <h4 class="font-bold text-gray-700">歷史紀錄 (已審核)</h4>
                            <div class="flex items-center space-x-2 text-sm w-full sm:w-auto">
                                <button onclick="openLeaveExportModal()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs whitespace-nowrap"><i class="fas fa-file-export mr-1"></i>匯出</button>
                                <span class="font-bold whitespace-nowrap">篩選日期:</span><input type="date" id="admin-leave-filter-date" class="border rounded p-1 text-xs flex-grow sm:flex-grow-0" onchange="renderAdminLeaves()"><button onclick="document.getElementById('admin-leave-filter-date').value=''; renderAdminLeaves()" class="text-blue-600 hover:underline text-xs whitespace-nowrap">清除篩選</button>
                            </div>
                        </div>
                        <div class="space-y-4 max-h-[500px] overflow-y-auto custom-scroll" id="admin-history-list"></div>
                    </div>
                </div>
                <!-- Announcements -->
                <div id="admin-view-announcements" class="admin-view hidden space-y-6">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-2">公告發布與管理</h3>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                            <h4 class="font-bold text-gray-700 mb-4">新增公告</h4>
                            <form onsubmit="handleAddAnnouncement(event)" class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    <div class="sm:col-span-2"><input type="text" id="announce-title" placeholder="標題" class="w-full text-sm border-gray-300 rounded p-2" required></div>
                                    <div><select id="announce-category" class="w-full text-sm border-gray-300 rounded p-2"><option value="general">一般</option><option value="urgent">緊急</option><option value="system">系統</option></select></div>
                                </div>
                                <div>
                                    <div class="border border-gray-300 rounded-t p-2 bg-gray-50 flex gap-2 border-b-0 items-center flex-wrap">
                                        <button type="button" onclick="execCmd('bold')" class="p-1 hover:bg-gray-200 rounded font-bold w-8 text-center">B</button>
                                        <button type="button" onclick="execCmd('italic')" class="p-1 hover:bg-gray-200 rounded italic w-8 text-center">I</button>
                                        <button type="button" onclick="execCmd('underline')" class="p-1 hover:bg-gray-200 rounded underline w-8 text-center">U</button>
                                        <div class="h-4 w-px bg-gray-300 mx-1"></div>
                                        <select onchange="execCmd('fontSize', this.value)" class="text-xs border rounded p-1"><option value="3">正常</option><option value="1">小</option><option value="5">大</option><option value="7">特大</option></select>
                                        <input type="color" onchange="execCmd('foreColor', this.value)" class="w-6 h-6 p-0 border-0 cursor-pointer">
                                    </div>
                                    <div id="announce-content" class="rich-editor-content text-sm rounded-t-none" contenteditable="true"></div>
                                </div>
                                <div class="text-right"><button type="submit" class="bg-blue-600 text-white text-sm px-6 py-2 rounded hover:bg-blue-700 shadow w-full sm:w-auto">發布</button></div>
                            </form>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                            <h4 class="font-bold text-gray-700 mb-4">已發布公告 (滑鼠滾動查看)</h4>
                            <div id="admin-announcement-list" class="space-y-3 max-h-[500px] overflow-y-auto custom-scroll pr-2"></div>
                        </div>
                    </div>
                </div>
                <!-- Holidays -->
                <div id="admin-view-holidays" class="admin-view hidden space-y-6">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-2">假期設定</h3>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl">
                        <div class="flex flex-col sm:flex-row gap-3 mb-6 items-end bg-gray-50 p-4 rounded-lg">
                            <div class="flex-1 w-full"><label class="block text-xs font-bold text-gray-500 mb-1">日期</label><input type="date" id="holiday-date" class="w-full border p-2 rounded-lg text-sm"></div>
                            <div class="flex-1 w-full"><label class="block text-xs font-bold text-gray-500 mb-1">備註</label><input type="text" id="holiday-note" placeholder="例: 中秋節" class="w-full border p-2 rounded-lg text-sm"></div>
                            <button onclick="addHoliday()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700 h-10 shadow-sm w-full sm:w-auto">新增</button>
                        </div>
                        <div id="holiday-list" class="space-y-2 max-h-[500px] overflow-y-auto custom-scroll"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Employee Dashboard -->
        <main id="employee-dashboard" class="flex-grow p-4 hidden bg-gray-50 overflow-y-auto custom-scroll">
            <div class="max-w-7xl mx-auto h-full flex flex-col gap-6 pb-6">
                <!-- Header Info -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col p-4 text-center flex-shrink-0">
                    <div class="text-lg font-medium opacity-90 mb-1 text-gray-600">打卡考勤</div>
                    <div id="emp-time" class="text-4xl sm:text-5xl font-mono font-bold tracking-wider mb-2 text-gray-800">00:00:00</div>
                    <div id="emp-date-full" class="text-blue-500 text-sm font-medium">--</div>
                </div>
                <!-- Location Status -->
                <div id="location-bar" class="p-3 rounded-lg text-center text-sm font-bold transition-colors bg-gray-200 text-gray-600 flex justify-center items-center gap-2 relative flex-shrink-0">
                    <span class="flex items-center"><i class="fas fa-location-arrow mr-2"></i><span id="location-text">尚未定位</span></span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- LEFT: Clock -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden h-fit">
                        <div class="p-4 sm:p-6 flex flex-col justify-center relative">
                            <div id="punch-container" class="grid grid-cols-2 gap-4 w-full">
                                <div class="relative w-full h-28 sm:h-32">
                                    <button id="btn-punch-in" onclick="attemptPunch('in')" class="w-full h-full flex flex-col items-center justify-center rounded-xl bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 transition-all active:scale-95 group"><i class="fas fa-sign-in-alt text-2xl sm:text-3xl mb-2"></i><span class="font-bold text-base sm:text-lg">上班</span></button>
                                    <div id="math-overlay-in" class="absolute inset-0 bg-white rounded-xl border-2 border-blue-500 hidden flex flex-col items-center justify-center z-10 p-2"><div class="w-full bg-gray-200 h-1 mb-2 rounded overflow-hidden"><div class="h-full bg-blue-500 w-full" id="timer-bar-in"></div></div><div class="font-bold text-lg text-gray-800 mb-2" id="math-q-in">?</div><div class="grid grid-cols-3 gap-1 w-full" id="math-options-in"></div></div>
                                </div>
                                <div class="relative w-full h-28 sm:h-32">
                                    <button id="btn-punch-out" onclick="attemptPunch('out')" class="w-full h-full flex flex-col items-center justify-center rounded-xl bg-orange-50 hover:bg-orange-100 text-orange-700 border border-orange-200 transition-all active:scale-95 group"><i class="fas fa-sign-out-alt text-2xl sm:text-3xl mb-2"></i><span class="font-bold text-base sm:text-lg">下班</span></button>
                                    <div id="math-overlay-out" class="absolute inset-0 bg-white rounded-xl border-2 border-orange-500 hidden flex flex-col items-center justify-center z-10 p-2"><div class="w-full bg-gray-200 h-1 mb-2 rounded overflow-hidden"><div class="h-full bg-orange-500 w-full" id="timer-bar-out"></div></div><div class="font-bold text-lg text-gray-800 mb-2" id="math-q-out">?</div><div class="grid grid-cols-3 gap-1 w-full" id="math-options-out"></div></div>
                                </div>
                            </div>
                            <p class="text-center text-xs text-red-500 mt-4 font-bold border-t pt-2 border-red-100"><i class="fas fa-exclamation-circle mr-1"></i> 請確認有打卡記錄再離開公司</p>
                        </div>
                        <div class="bg-gray-50 border-t border-gray-200 p-4">
                            <div class="flex justify-between items-center mb-3"><h4 class="text-xs font-bold text-gray-500">最近打卡紀錄 (近2筆)</h4><button onclick="openRecordModal()" class="text-xs text-blue-600 hover:underline">查看更多 (3個月)</button></div>
                            <div class="grid grid-cols-4 gap-1 text-xs text-gray-500 font-bold mb-2 px-2"><div>日期</div><div>上班時間</div><div>下班時間</div><div class="text-right">狀態</div></div>
                            <div id="punch-preview-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <!-- RIGHT: Leave -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 sm:p-6 flex flex-col h-fit">
                        <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-3"><h3 class="font-bold text-gray-800 flex items-center"><i class="fas fa-calendar-alt text-purple-600 mr-2"></i> 請假申請</h3></div>
                        <div id="emp-quota-stats" class="grid grid-cols-3 gap-2 mb-4"></div>
                        <form id="leave-form" onsubmit="handleLeaveSubmit(event)" class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-gray-500 block mb-1 font-bold">開始日期</label><input type="date" id="leave-start-date" onchange="calcLeavePreview()" class="w-full text-sm border-gray-300 rounded-lg p-2" required></div>
                                <div><label class="text-xs text-gray-500 block mb-1 font-bold">結束日期</label><input type="date" id="leave-end-date" onchange="calcLeavePreview()" class="w-full text-sm border-gray-300 rounded-lg p-2" required></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-gray-500 block mb-1 font-bold">開始時間</label><select id="leave-start-time" onchange="calcLeavePreview()" class="w-full text-sm border-gray-300 rounded-lg p-2"></select></div>
                                <div><label class="text-xs text-gray-500 block mb-1 font-bold">結束時間</label><select id="leave-end-time" onchange="calcLeavePreview()" class="w-full text-sm border-gray-300 rounded-lg p-2"></select></div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1 font-bold">假別</label>
                                <select id="leave-type" onchange="toggleOtherInput()" class="w-full text-sm border-gray-300 rounded-lg p-2" required>
                                    <option value="特休">特休</option><option value="補休">補休</option><option value="生日假">生日假</option>
                                    <option value="事假">事假</option><option value="病假">病假</option><option value="公假">公假</option><option value="婚假">婚假</option><option value="喪假">喪假</option><option value="產假">產假</option><option value="陪產假">陪產假</option><option value="生理假">生理假</option><option value="家庭照顧假">家庭照顧假</option><option value="工傷病假">工傷病假</option><option value="其他">其他</option>
                                </select>
                                <input type="text" id="leave-type-other" placeholder="假別名稱" class="mt-2 w-full text-sm border-gray-300 rounded-lg p-2 hidden">
                            </div>
                            <div><label class="text-xs text-gray-500 block mb-1 font-bold">事由</label><textarea id="leave-reason" rows="2" placeholder="請輸入事由" class="w-full text-sm border-gray-300 rounded-lg p-2" required></textarea></div>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm space-y-1">
                                <div class="flex justify-between"><span class="text-gray-500">假別</span> <span id="preview-type" class="font-bold">--</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">時數</span> <span id="preview-hours" class="font-bold text-purple-600">0 小時</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">時間</span> <span id="preview-range" class="text-xs text-gray-800 font-bold">--</span></div>
                                <div id="leave-error-msg" class="text-xs text-red-500 font-bold hidden text-right mt-1"></div>
                            </div>
                            <button type="submit" id="leave-submit-btn" class="w-full bg-gray-800 hover:bg-gray-900 text-white text-sm font-medium py-3 rounded-lg transition shadow-md">送出申請</button>
                        </form>
                        <div class="mt-auto border-t border-gray-100 pt-3">
                            <div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-gray-500">最近申請紀錄 (1筆)</h4><button onclick="openLeaveHistoryModal()" class="text-xs text-blue-600 hover:underline">查看更多 (1年內)</button></div>
                            <div id="leave-preview-item"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4">新增員工</h3>
            <div class="space-y-3"><input type="text" id="new-user-id" placeholder="登入帳號" class="w-full border rounded p-2 text-sm"><input type="text" id="new-user-pass" placeholder="登入密碼" class="w-full border rounded p-2 text-sm"><input type="text" id="new-user-name" placeholder="員工姓名" class="w-full border rounded p-2 text-sm"><input type="text" id="new-user-dept" placeholder="部門" class="w-full border rounded p-2 text-sm"></div>
            <div class="flex space-x-3 mt-4"><button onclick="closeModal('add-user-modal')" class="flex-1 py-2 bg-gray-100 rounded text-sm">取消</button><button onclick="saveNewUser()" class="flex-1 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">儲存</button></div>
        </div>
    </div>
    
    <div id="employee-settings-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 m-4 flex flex-col max-h-[90vh]">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex-shrink-0">員工設定 - <span id="setting-user-name"></span></h3>
            <div class="space-y-4 overflow-y-auto custom-scroll flex-1 p-1">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">到職日期</label><input type="date" id="setting-onboard-date" class="w-full border rounded p-2 text-sm" onchange="updateAnnualLeaveCalc()"><div id="calc-result" class="text-xs text-blue-600 mt-1 font-bold"></div></div>
                <div class="border-t pt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">假別額度設定 (小時)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs text-gray-500 mb-1">特休假</label><input type="number" id="setting-annual-hours" class="w-full border rounded p-2 text-sm" placeholder="自動計算"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">生日假</label><input type="number" id="setting-birthday-hours" class="w-full border rounded p-2 text-sm" placeholder="手動輸入"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">補休假</label><input type="number" id="setting-comp-hours" class="w-full border rounded p-2 text-sm" placeholder="手動輸入"></div>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2 mt-4">
                         <h4 class="text-sm font-bold text-gray-700">請假歷史 (特休/補休/生日)</h4>
                         <button onclick="exportSingleEmployeeLeaves(state.settingTargetId)" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200"><i class="fas fa-file-export mr-1"></i>匯出紀錄</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-2" id="setting-stats-preview"></div>
                    <div class="bg-gray-50 border rounded p-2 h-32 overflow-y-auto custom-scroll text-xs" id="setting-history-list"></div>
                </div>
            </div>
            <div class="flex space-x-3 mt-6 flex-shrink-0"><button onclick="closeModal('employee-settings-modal')" class="flex-1 py-2 bg-gray-100 rounded text-sm">取消</button><button onclick="saveEmployeeSettings()" class="flex-1 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">儲存設定</button></div>
        </div>
    </div>

    <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[110] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4" id="cp-title">修改密碼</h3>
            <div class="space-y-3"><input type="password" id="cp-new-pass" placeholder="新密碼" class="w-full border rounded p-2 text-sm"><input type="password" id="cp-new-pass-confirm" placeholder="確認新密碼" class="w-full border rounded p-2 text-sm"><p class="text-xs text-gray-500">請輸入兩次新密碼。</p></div>
            <div class="flex space-x-3 mt-4"><button onclick="closeModal('change-password-modal')" class="flex-1 py-2 bg-gray-100 rounded text-sm">取消</button><button onclick="submitChangePassword()" class="flex-1 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">確認修改</button></div>
        </div>
    </div>
    
    <div id="permanent-delete-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4 text-center border-t-4 border-red-600">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-2xl"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">警告：永久刪除</h3>
            <p class="text-sm text-gray-600 mb-6">此操作將<span class="font-bold text-red-600">永久移除</span>該員工的所有資料。<br>此動作無法復原！</p>
            <button id="btn-confirm-permanent" onclick="confirmHardDelete()" class="w-full py-3 bg-gray-300 text-gray-500 font-bold rounded-lg cursor-not-allowed transition-colors" disabled>請稍候 (5)</button>
            <button onclick="closeModal('permanent-delete-modal')" class="mt-3 text-sm text-gray-500 hover:underline">取消</button>
        </div>
    </div>

    <div id="verify-math-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center relative m-4">
            <div class="mb-4"><div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-500"><i class="fas fa-shield-alt"></i></div><h3 class="text-lg font-bold text-gray-800">安全驗證</h3><p class="text-sm text-gray-500 mb-2">請回答以下問題以確認操作</p><div id="verify-math-q" class="text-2xl font-bold text-blue-600 mb-4"></div><div class="grid grid-cols-3 gap-2" id="verify-math-options"></div></div><button onclick="closeModal('verify-math-modal')" class="w-full py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">取消</button>
        </div>
    </div>
    <div id="reject-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3">拒絕原因</h3>
            <textarea id="reject-reason-input" rows="3" class="w-full border rounded p-2 text-sm mb-4" placeholder="請填寫原因..."></textarea>
            <div class="flex space-x-3"><button onclick="closeModal('reject-modal')" class="flex-1 py-2 bg-gray-100 rounded">取消</button><button onclick="submitReject()" class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700">送出</button></div>
        </div>
    </div>
    <div id="record-history-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col m-4">
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0"><h3 class="font-bold text-lg">打卡紀錄 (近3個月)</h3><button onclick="closeModal('record-history-modal')"><i class="fas fa-times"></i></button></div>
            <div class="p-4 bg-gray-50 border-b flex flex-col sm:flex-row gap-2 flex-shrink-0"><div class="flex items-center gap-2 text-sm text-gray-600 w-full sm:w-auto"><span class="whitespace-nowrap">篩選:</span><input type="date" id="record-filter-start" class="border rounded p-1 w-full sm:w-auto"><span>-</span><input type="date" id="record-filter-end" class="border rounded p-1 w-full sm:w-auto"></div><button onclick="renderRecordHistory()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm w-full sm:w-auto">搜尋</button></div>
            <div class="overflow-y-auto p-4 custom-scroll flex-1 min-h-0"><div class="grid grid-cols-4 gap-1 text-xs text-gray-500 font-bold mb-2 px-2 bg-gray-100 p-2 rounded"><div>日期</div><div>上班</div><div>下班</div><div class="text-right">狀態</div></div><table class="w-full text-sm text-left"><tbody id="record-history-body" class="divide-y"></tbody></table></div>
        </div>
    </div>
    <div id="leave-history-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[80vh] flex flex-col m-4">
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0"><h3 class="font-bold text-lg">請假紀錄</h3><button onclick="closeModal('leave-history-modal')"><i class="fas fa-times"></i></button></div>
            <div class="p-4 bg-gray-50 border-b flex flex-col sm:flex-row flex-wrap gap-2 items-center flex-shrink-0">
                <select id="leave-filter-type" onchange="renderLeaveHistoryModal()" class="border rounded p-2 text-sm w-full sm:w-32"><option value="all">所有假別</option><option value="特休">特休</option><option value="事假">事假</option><option value="病假">病假</option><option value="公假">公假</option><option value="婚假">婚假</option><option value="喪假">喪假</option><option value="產假">產假</option><option value="陪產假">陪產假</option><option value="生理假">生理假</option><option value="家庭照顧假">家庭照顧假</option><option value="工傷病假">工傷病假</option><option value="其他">其他</option></select>
                <div class="flex items-center gap-1 text-sm text-gray-600 w-full sm:w-auto"><span class="font-bold whitespace-nowrap">日期:</span><input type="date" id="leave-filter-date" class="border rounded p-1 w-full sm:w-32" onchange="renderLeaveHistoryModal()"></div>
                <div class="flex gap-2 w-full sm:w-auto"><button onclick="clearLeaveFilters()" class="text-gray-500 text-sm underline whitespace-nowrap">清除篩選</button></div>
            </div>
            <div class="overflow-y-auto p-4 custom-scroll flex-1 min-h-0"><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2 whitespace-nowrap">假別</th><th class="p-2 whitespace-nowrap">日期範圍</th><th class="p-2 whitespace-nowrap">時數</th><th class="p-2 whitespace-nowrap">事由</th><th class="p-2 whitespace-nowrap">狀態</th><th class="p-2 whitespace-nowrap">操作</th></tr></thead><tbody id="leave-history-body"></tbody></table></div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-file-csv text-green-600 mr-2"></i>匯出打卡紀錄</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">開始日期</label><input type="date" id="export-start-date" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">結束日期</label><input type="date" id="export-end-date" class="w-full border rounded p-2 text-sm"></div>
                <p class="text-xs text-gray-500">將匯出選定期間內所有員工的打卡資料。</p>
            </div>
            <div class="flex space-x-3 mt-6"><button onclick="closeModal('export-modal')" class="flex-1 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200">取消</button><button onclick="performExport()" class="flex-1 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 shadow">確認匯出</button></div>
        </div>
    </div>
    
    <!-- Leave Export Modal -->
    <div id="leave-export-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-file-csv text-green-600 mr-2"></i>匯出請假紀錄</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">開始日期</label><input type="date" id="leave-export-start-date" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">結束日期</label><input type="date" id="leave-export-end-date" class="w-full border rounded p-2 text-sm"></div>
                <p class="text-xs text-gray-500">將匯出選定期間內的所有已審核請假資料。</p>
            </div>
            <div class="flex space-x-3 mt-6"><button onclick="closeModal('leave-export-modal')" class="flex-1 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200">取消</button><button onclick="performLeaveExport()" class="flex-1 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 shadow">確認匯出</button></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/90 z-[9999] flex flex-col justify-center items-center"><div class="w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin mb-4"></div><div class="text-gray-600 font-bold" id="loading-text">資料同步中...</div></div>
    <!-- Sync -->
    <div id="sync-status" class="fixed bottom-2 right-2 text-xs text-gray-400 z-50 bg-white/80 px-2 py-1 rounded pointer-events-none"><i class="fas fa-cloud"></i> 準備就緒</div>

    <script>
        const COMPANY_LAT = 24.1702930000;
        const COMPANY_LNG = 120.7117220000;
        const ALLOWED_RADIUS = 50; 
        const ITEMS_PER_PAGE = 10;
        const STORAGE_KEY = 'attendance_system_data';
        const SESSION_KEY = 'attendance_session';
        const IDLE_TIMEOUT = 5 * 60 * 1000;
        const LABOR_ACT_TYPES = ["特休", "事假", "病假", "公假", "婚假", "喪假", "產假", "陪產假", "生理假", "家庭照顧假", "工傷病假"];
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwSEyoTer1JDFBpbG3XFDuRaXUbvhFUqc9v-Idhp79VHJqlEkiugjIHFEAk7Jr_Wg_8Ig/exec"; 

        let watchId = null; let idleTimer = null; let hardDeleteTargetId = null; let deleteTimer = null;
        let state = {
            currentUser: null, currentView: 'overview', adminLeavePage: 1, distance: null, pendingVerifyCallback: null,
            holidays: [{ id: 1, date: '2023-01-01', note: '元旦' }, { id: 2, date: '2026-01-01', note: '元旦(2026)' }],
            users: [{ id: 'admin', pass: '123', name: '系統管理員', role: 'admin', dept: 'HR' }, { id: 'emp', pass: '123', name: '王小明', role: 'employee', dept: 'IT部' }],
            records: [], leaves: [], announcements: [], pendingAction: null,
            pwdTargetId: null, settings: { lat: 24.1702930000, lng: 120.7117220000, radius: 50 },
            settingTargetId: null
        };

        // --- GLOBAL & UI FUNCTIONS (HOISTED) ---
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            if(id === 'permanent-delete-modal') clearInterval(deleteTimer);
        }
        function openRecordModal() { document.getElementById('record-history-modal').classList.remove('hidden'); renderRecordHistory(); }
        function openLeaveHistoryModal() { document.getElementById('leave-history-modal').classList.remove('hidden'); renderLeaveHistoryModal(); }
        function getCatLabel(cat) { return cat==='urgent'?'緊急':cat==='system'?'系統':'一般'; }
        function showToast(msg, type='info') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            toast.classList.remove('translate-x-full', 'opacity-0', 'pointer-events-none');
            const content = document.getElementById('toast-content');
            content.className = `bg-white border-l-4 rounded shadow-lg p-4 flex items-center w-full md:w-auto transition-all ${type==='error'?'border-red-500':type==='success'?'border-green-500':'border-blue-500'}`;
            setTimeout(() => toast.classList.add('translate-x-full', 'opacity-0', 'pointer-events-none'), 3000);
        }
        function execCmd(c,v=null){document.execCommand(c,false,v);}
        function toggleLoading(show, text="資料同步中...") {
            const el = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            if(show) { txt.textContent = text; el.classList.remove('hidden'); } else { el.classList.add('hidden'); }
        }
        function updateSyncStatus(status) {
            const el = document.getElementById('sync-status');
            if(status === 'syncing') el.innerHTML = '<i class="fas fa-sync fa-spin text-blue-500"></i> 同步中...';
            else if(status === 'success') { el.innerHTML = '<i class="fas fa-check text-green-500"></i> 已同步'; setTimeout(()=>el.innerHTML='<i class="fas fa-cloud"></i> 準備就緒', 2000); }
            else if(status === 'error') el.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i> 同步失敗';
        }
        function getLocalISOString() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            return new Date(now.getTime() - offset).toISOString().split('T')[0];
        }
        function getFullDateString(dateObj) {
            const y = dateObj.getFullYear() - 1911;
            const m = dateObj.getMonth() + 1;
            const d = dateObj.getDate();
            const w = ['日','一','二','三','四','五','六'][dateObj.getDay()];
            return `民國 ${y} 年 ${m} 月 ${d} 日 (星期${w})`;
        }
        function cleanDate(str) {
            if (!str) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
            const d = new Date(str);
            if (isNaN(d.getTime())) return str;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }
        function cleanTime(str) {
            if (!str) return '';
            if (/^\d{2}:\d{2}(:\d{2})?$/.test(str)) return str;
            const d = new Date(str);
            if (isNaN(d.getTime())) return str;
            const h = String(d.getHours()).padStart(2, '0');
            const m = String(d.getMinutes()).padStart(2, '0');
            const s = String(d.getSeconds()).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        function cleanDateTime(str) {
            if (!str) return '';
            const d = new Date(str);
            if (isNaN(d.getTime())) return str;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const h = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${day} ${h}:${min}`;
        }
        function renderLoginAnnouncements(){document.getElementById('login-announcement-list').innerHTML=state.announcements.length?state.announcements.map(a=>`<div class="p-3 bg-white border-l-4 border-blue-500 rounded shadow-sm mb-3"><div class="flex items-center gap-2 mb-1"><span class="px-2 py-0.5 rounded text-xs font-bold badge-${a.category}">${getCatLabel(a.category)}</span><span class="font-bold text-gray-800">${a.title}</span></div><div class="text-xs text-gray-400 mb-2">${cleanDate(a.date)}</div><div class="text-sm text-gray-600">${a.content}</div></div>`).join(''):'<div class="text-center text-gray-400 py-4">暫無公告</div>';}
        function stopLocationWatch() { if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; } }
        function recalculateAllLeaves(){state.leaves.forEach(l=>{if(l.status==='pending'||l.status==='approved'){const s=l.start.split(' ');const e=l.end.split(' ');l.hours=calculateLeaveHoursInternal(s[0],s[1],e[0],e[1]);}}); saveData(); renderAdminLeaves(); if(state.currentUser&&state.currentUser.role==='employee')renderLeavePreview();}

        // --- MATH & GEO HELPERS ---
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            var d = R * c * 1000;
            return d;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }

        // --- LOCATION FUNCTIONS ---
        function startLocationWatch() {
            if (!navigator.geolocation) { updateLocationUI(null, "不支援定位"); return; }
            updateLocationUI(null, "定位中...");
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const dist = getDistanceFromLatLonInM(pos.coords.latitude, pos.coords.longitude, state.settings.lat, state.settings.lng);
                    state.distance = dist;
                    state.currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude }; 
                    updateLocationUI(dist);
                },
                (err) => {
                    console.warn("Watch failed, retrying single shot...");
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const dist = getDistanceFromLatLonInM(pos.coords.latitude, pos.coords.longitude, state.settings.lat, state.settings.lng);
                            state.distance = dist;
                            state.currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                            updateLocationUI(dist);
                        },
                        (err2) => { updateLocationUI(null, "定位失敗 (請允許權限)"); },
                        { enableHighAccuracy: false, timeout: 30000, maximumAge: 0 }
                    );
                }, { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
            );
        }
        function updateLocationUI(dist, overrideText=null) {
            const bar = document.getElementById('location-bar'); const txt = document.getElementById('location-text'); if(!bar) return;
            if (overrideText) { bar.className = "p-3 rounded-lg text-center text-sm font-bold transition-colors bg-blue-100 text-blue-800 flex justify-center items-center gap-2"; txt.textContent = overrideText; return; }
            if(dist === null) { bar.className = "p-3 rounded-lg text-center text-sm font-bold transition-colors bg-gray-200 text-gray-600 flex justify-center items-center gap-2"; txt.textContent = "定位失敗 / 尚未定位"; } 
            else if(dist <= state.settings.radius) { bar.className = "p-3 rounded-lg text-center text-sm font-bold transition-colors bg-green-100 text-green-800 flex justify-center items-center gap-2"; txt.textContent = `距離公司 ${dist.toFixed(1)} 公尺 (範圍內)`; } 
            else { bar.className = "p-3 rounded-lg text-center text-sm font-bold transition-colors bg-red-100 text-red-800 flex justify-center items-center gap-2"; txt.textContent = `距離公司 ${dist.toFixed(1)} 公尺 (不在範圍內)`; }
        }

        // --- PUNCH FUNCTIONS ---
        async function attemptPunch(type) {
            if(type === 'in' && (state.distance === null || state.distance > state.settings.radius)) { 
                showToast(`上班打卡需在公司範圍內 (${state.settings.radius}公尺)`, "error"); 
                return; 
            }
            startMathChallenge(type);
        }
        function startMathChallenge(type) {
            const overlay = document.getElementById(`math-overlay-${type}`);
            const qEl = document.getElementById(`math-q-${type}`);
            const optsEl = document.getElementById(`math-options-${type}`);
            const bar = document.getElementById(`timer-bar-${type}`);
            const n1 = Math.floor(Math.random()*9)+1, n2 = Math.floor(Math.random()*9)+1;
            const ans = n1+n2; 
            qEl.textContent = `${n1} + ${n2} = ?`;
            optsEl.innerHTML = [ans, ans+1, ans-1].sort(()=>Math.random()-0.5).map(o=>
                `<button onclick="checkMath('${type}',${o},${ans})" class="bg-gray-100 hover:bg-gray-200 py-2 rounded font-bold">${o}</button>`
            ).join('');
            overlay.classList.remove('hidden');
            bar.style.width = '100%'; 
            setTimeout(()=>bar.style.width='0%', 10);
        }
        function checkMath(type, sel, ans) {
            document.getElementById(`math-overlay-${type}`).classList.add('hidden');
            if(sel !== ans) return showToast('驗證錯誤', 'error');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', {hour12:false});
            const dateStr = getLocalISOString();
            const recordLat = state.currentPos ? state.currentPos.lat : (state.settings ? state.settings.lat : 0);
            const recordLng = state.currentPos ? state.currentPos.lng : (state.settings ? state.settings.lng : 0);
            const punchDist = state.distance !== null ? state.distance : -1;
            state.records.unshift({ id: Date.now(), userId: state.currentUser.id, date: dateStr, time: timeStr, type: type, status: '正常', dist: punchDist, lat: recordLat, lng: recordLng });
            saveData(); renderPunchPreview(); showToast('打卡成功', 'success');
        }
        function initMathVerify(callback) {
            state.pendingVerifyCallback = callback;
            const n1 = Math.floor(Math.random()*9)+1, n2 = Math.floor(Math.random()*9)+1;
            const ans = n1+n2;
            document.getElementById('verify-math-q').textContent = `${n1} + ${n2} = ?`;
            document.getElementById('verify-math-options').innerHTML = [ans, ans+1, ans-1].sort(()=>Math.random()-0.5).map(o=>
                `<button onclick="checkGenericVerify(${o}, ${ans})" class="bg-blue-100 hover:bg-blue-200 py-3 rounded-lg font-bold text-blue-800 text-lg">${o}</button>`
            ).join('');
            document.getElementById('verify-math-modal').classList.remove('hidden');
        }
        function checkGenericVerify(sel, ans) {
            if(sel === ans) { if(state.pendingVerifyCallback) state.pendingVerifyCallback(); closeModal('verify-math-modal'); }
            else { showToast('驗證錯誤，請重試', 'error'); closeModal('verify-math-modal'); }
        }

        // --- RENDERERS ---
        function renderPunchPreview() {
            const list = state.records.filter(r => r.userId === state.currentUser.id).slice(0, 2);
            document.getElementById('punch-preview-list').innerHTML = list.map(r => {
                const isIN = r.type === 'in';
                const label = isIN ? '上班打卡成功' : '下班打卡成功';
                const bgClass = isIN ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const colIn = isIN ? `<div class="font-mono">${r.time}</div>` : `<div class="text-left text-gray-300">----</div>`;
                const colOut = !isIN ? `<div class="font-mono">${r.time}</div>` : `<div class="text-left text-gray-300">----</div>`;
                return `<div class="grid grid-cols-4 gap-1 items-center text-sm p-3 ${bgClass} rounded mb-2 font-medium"><div>${r.date}</div><div>${colIn}</div><div>${colOut}</div><div class="text-right text-xs">${label}</div></div>`
            }).join('');
        }
        function renderLeavePreview() {
            const l = state.leaves.find(x => x.userId === state.currentUser.id);
            let statusHtml = '<span class="text-gray-400">無狀態</span>'; let rejectHtml = '';
            if(l) {
                if(l.status === 'pending') statusHtml = '<span class="text-yellow-800 bg-yellow-100 px-2 py-0.5 rounded text-xs">審核中</span>';
                else if(l.status === 'approved') statusHtml = '<span class="text-green-700 bg-green-100 px-2 py-0.5 rounded text-xs">審核通過</span>';
                else if(l.status === 'rejected') { statusHtml = '<span class="text-red-700 bg-red-100 px-2 py-0.5 rounded text-xs">被拒絕</span>'; rejectHtml = `<div class="text-red-600 text-xs mt-1 border-t border-red-100 pt-1">拒絕原因: ${l.rejectReason}</div>`; }
                else if(l.status === 'cancelled') statusHtml = '<span class="text-gray-500 bg-gray-100 px-2 py-0.5 rounded text-xs">已取消</span>';
            }
            document.getElementById('leave-preview-item').innerHTML = l ? `<div class="p-3 bg-white rounded border text-sm shadow-sm"><div class="flex justify-between font-bold"><span>${l.type} (${l.hours}h)</span> ${statusHtml}</div><div class="text-xs text-gray-800 font-bold mt-1">請假時間：${l.start} ~ ${l.end}</div><div class="text-xs text-gray-500 mt-1">事由: ${l.reason}</div>${rejectHtml}${l.status==='pending' ? `<button onclick="initCancel(${l.id})" class="text-xs text-red-500 border border-red-200 rounded px-2 py-1 mt-2 w-full hover:bg-red-50">取消申請</button>`:''}</div>` : '<div class="text-center text-gray-400 text-xs">無紀錄</div>';
        }
        function renderEmployeeDashboard() { renderPunchPreview(); renderLeavePreview(); calcLeavePreview(); renderEmpQuotaStats(); }

        function renderRecordHistory(){
            const s=document.getElementById('record-filter-start').value; 
            const e=document.getElementById('record-filter-end').value; 
            let list=state.records.filter(r=>r.userId===state.currentUser.id); 
            if(s&&e)list=list.filter(r=>r.date>=s&&r.date<=e); 
            document.getElementById('record-history-body').innerHTML=list.map(r=>{
                const isIN=r.type==='in';
                const label=isIN?'上班打卡成功':'下班打卡成功';
                const bgClass=isIN?'bg-green-100 text-green-800':'bg-red-100 text-red-800';
                const colIn=isIN?r.time:'----';
                const colOut=!isIN?r.time:'----';
                return`<tr><td colspan="4" class="p-1"><div class="grid grid-cols-4 gap-1 ${bgClass} p-2 rounded text-xs font-bold items-center"><div>${r.date}</div><div class="text-left font-mono">${colIn}</div><div class="text-left font-mono">${colOut}</div><div class="text-right">${label}</div></div></td></tr>`;
            }).join('');
        }

        function renderLeaveHistoryModal(){
            const typeFilter = document.getElementById('leave-filter-type').value; 
            const dateFilter = document.getElementById('leave-filter-date').value; 
            let list = state.leaves.filter(x => x.userId === state.currentUser.id);
            
            if(typeFilter === '其他') { list = list.filter(l => !LABOR_ACT_TYPES.includes(l.type)); } 
            else if(typeFilter !== 'all') { list = list.filter(l => l.type === typeFilter); }
            
            if(dateFilter) { list = list.filter(l => { const start = l.start.split(' ')[0]; const end = l.end.split(' ')[0]; return dateFilter >= start && dateFilter <= end; }); }
            
            document.getElementById('leave-history-body').innerHTML=list.map(l=>{
                let sText='審核中',sClass='text-yellow-700';
                if(l.status==='approved'){sText='審核通過';sClass='text-green-600';}
                if(l.status==='rejected'){sText='被拒絕';sClass='text-red-500';}
                if(l.status==='cancelled'){sText='已取消';sClass='text-gray-500';}
                let btn='';
                if(l.status==='pending')btn=`<button onclick="initCancel(${l.id})" class="text-red-500 hover:underline text-xs">取消</button>`;
                return`<tr class="border-b"><td class="p-2 font-bold whitespace-nowrap">${l.type}</td><td class="p-2 text-xs whitespace-nowrap">${l.start}<br>~ ${l.end}</td><td class="p-2 whitespace-nowrap">${l.hours}</td><td class="p-2 text-xs truncate max-w-[100px]" title="${l.reason}">${l.reason}<br>${l.status==='rejected'?`<span class="text-red-500">(${l.rejectReason})</span>`:''}</td><td class="p-2 text-xs font-bold ${sClass} whitespace-nowrap">${sText}</td><td class="p-2">${btn}</td></tr>`
            }).join('');
        }

        function clearLeaveFilters(){
            document.getElementById('leave-filter-type').value='all';
            document.getElementById('leave-filter-date').value='';
            renderLeaveHistoryModal();
        }

        // --- DATA PERSISTENCE ---
        async function loadData() {
            if(!GAS_API_URL) {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    state.holidays = parsed.holidays || state.holidays;
                    state.users = parsed.users || state.users;
                    state.records = parsed.records || state.records;
                    state.leaves = parsed.leaves || state.leaves;
                    state.announcements = parsed.announcements || state.announcements;
                    if (!state.users.some(u => u.id === 'admin')) {
                        state.users.unshift({ id: 'admin', pass: '123', name: '系統管理員', role: 'admin', dept: 'HR' });
                    }
                    if (state.users.length === 1 && state.users[0].id === 'admin') {
                         state.users.push({ id: 'emp', pass: '123', name: '王小明', role: 'employee', dept: 'IT部' });
                    }
                    state.settings = parsed.settings || { lat: 24.1702930000, lng: 120.7117220000, radius: 50 };
                    state.users.forEach(u => { 
                        if(typeof u.deleted === 'undefined') u.deleted = false; 
                        if(typeof u.quota_annual === 'undefined') u.quota_annual = 0;
                        if(typeof u.quota_birthday === 'undefined') u.quota_birthday = 0;
                        if(typeof u.quota_comp === 'undefined') u.quota_comp = 0;
                    });
                }
                return;
            }
            try {
                toggleLoading(true, "正在讀取雲端資料...");
                const res = await fetch(GAS_API_URL);
                const data = await res.json();
                if(data) {
                    if (data.holidays) state.holidays = data.holidays.map(h => ({ ...h, date: cleanDate(h.date) }));
                    if (data.users) state.users = data.users;
                    if (data.records) state.records = data.records.map(r => ({ ...r, date: cleanDate(r.date), time: cleanTime(r.time) }));
                    if (data.leaves) state.leaves = data.leaves.map(l => ({ ...l, start: cleanDateTime(l.start), end: cleanDateTime(l.end) }));
                    if (data.announcements) state.announcements = data.announcements.map(a => ({ ...a, date: cleanDate(a.date) }));
                    state.settings = data.settings || { lat: 24.1702930000, lng: 120.7117220000, radius: 50 };
                    
                    if (!state.users.some(u => u.id === 'admin')) {
                        state.users.unshift({ id: 'admin', pass: '123', name: '系統管理員', role: 'admin', dept: 'HR' });
                    }
                    state.users.forEach(u => { 
                        if(typeof u.deleted === 'undefined') u.deleted = false;
                        if(typeof u.quota_annual === 'undefined') u.quota_annual = 0;
                        if(typeof u.quota_birthday === 'undefined') u.quota_birthday = 0;
                        if(typeof u.quota_comp === 'undefined') u.quota_comp = 0;
                    });
                }
                toggleLoading(false);
            } catch(e) {
                console.error("Load Error", e);
                showToast("雲端資料讀取失敗，切換至本機模式", "error");
                toggleLoading(false);
            }
        }
        async function saveData() {
            if(!GAS_API_URL) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    holidays: state.holidays, users: state.users, records: state.records, leaves: state.leaves, announcements: state.announcements, settings: state.settings
                }));
                return;
            }
            updateSyncStatus('syncing');
            try {
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        holidays: state.holidays, users: state.users, records: state.records, leaves: state.leaves, announcements: state.announcements, settings: state.settings
                    })
                });
                updateSyncStatus('success');
            } catch(e) {
                console.error("Save Error", e);
                updateSyncStatus('error');
            }
        }
        function saveSession() {
            if (state.currentUser) {
                localStorage.setItem(SESSION_KEY, JSON.stringify({ user: state.currentUser, view: state.currentView }));
                // Remember Me
                const rememberMe = document.getElementById('remember-me');
                if(rememberMe && rememberMe.checked) {
                    const expiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
                    localStorage.setItem('auth_auto_login', JSON.stringify({ id: state.currentUser.id, pass: state.currentUser.pass, expiry: expiry }));
                    localStorage.setItem('saved_username', state.currentUser.id);
                } else {
                    localStorage.removeItem('auth_auto_login');
                    localStorage.removeItem('saved_username');
                }
            }
            else localStorage.removeItem(SESSION_KEY);
        }
        function loadSession() {
            const session = localStorage.getItem(SESSION_KEY);
            return session ? JSON.parse(session) : null;
        }

        // --- AUTH & USER ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.toLowerCase().trim();
            const p = document.getElementById('password').value;
            const user = state.users.find(x => x.id.toLowerCase() === u && x.pass === p);
            if(user) {
                if (user.deleted) { document.getElementById('login-inactive-error').classList.remove('hidden'); document.getElementById('login-error').classList.add('hidden'); } 
                else {
                    const rememberMe = document.getElementById('remember-me').checked;
                    if (rememberMe) {
                        const expiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
                        localStorage.setItem('auth_auto_login', JSON.stringify({ id: user.id, pass: user.pass, expiry: expiry }));
                        localStorage.setItem('saved_username', user.id);
                    } else {
                        localStorage.removeItem('auth_auto_login');
                        localStorage.removeItem('saved_username');
                    }
                    performLogin(user); 
                }
            } else { document.getElementById('login-error').classList.remove('hidden'); document.getElementById('login-inactive-error').classList.add('hidden'); }
        }

        function performLogin(user, view = 'overview') {
            state.currentUser = user; state.currentView = view; saveSession(); setupIdleListeners();
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('header-user-name').textContent = `${user.name}`;
            if(user.role === 'admin') {
                document.getElementById('admin-dashboard').classList.remove('hidden');
                switchAdminTab(view);
            } else {
                document.getElementById('employee-dashboard').classList.remove('hidden');
                renderEmployeeDashboard();
                setTimeout(() => { startLocationWatch(); }, 500);
            }
        }

        function logout() {
            state.currentUser = null; saveSession(); stopLocationWatch(); if(idleTimer) clearTimeout(idleTimer);
            document.getElementById('app-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('password').value = ''; 
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-inactive-error').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden'); document.getElementById('employee-dashboard').classList.add('hidden');
            renderLoginAnnouncements();
        }

        function openChangePasswordModal(userId = null) {
            state.pwdTargetId = userId || state.currentUser.id;
            const title = userId ? `修改 ${userId} 的密碼` : '修改個人密碼';
            document.getElementById('cp-title').textContent = title;
            document.getElementById('cp-new-pass').value = '';
            document.getElementById('cp-new-pass-confirm').value = '';
            document.getElementById('change-password-modal').classList.remove('hidden');
        }
        function submitChangePassword() {
            const newPass = document.getElementById('cp-new-pass').value;
            const confirmPass = document.getElementById('cp-new-pass-confirm').value;
            if (!newPass) { alert('請輸入新密碼'); return; }
            if (newPass !== confirmPass) { alert('兩次輸入的密碼不一致'); return; }
            const targetUser = state.users.find(u => u.id === state.pwdTargetId);
            if (targetUser) { targetUser.pass = newPass; saveData(); showToast('密碼修改成功', 'success'); closeModal('change-password-modal'); } else { showToast('找不到使用者', 'error'); }
        }
        function toggleDeletedUsers() {
            const btn = document.getElementById('btn-toggle-deleted');
            const isShowingDeleted = btn.classList.contains('bg-red-200');
            if (isShowingDeleted) {
                btn.classList.remove('bg-red-200', 'text-red-800');
                btn.classList.add('bg-gray-200', 'text-gray-700');
                btn.innerHTML = '<i class="fas fa-trash-restore mr-1"></i> 查看已刪除';
                renderOverview(false);
            } else {
                btn.classList.remove('bg-gray-200', 'text-gray-700');
                btn.classList.add('bg-red-200', 'text-red-800');
                btn.innerHTML = '<i class="fas fa-users mr-1"></i> 返回正常列表';
                renderOverview(true);
            }
        }
        function restoreUser(id) {
            const u = state.users.find(u => u.id === id);
            if(u) {
                u.deleted = false;
                saveData();
                const isShowingDeleted = document.getElementById('btn-toggle-deleted').classList.contains('bg-red-200');
                renderOverview(isShowingDeleted);
                showToast('員工已還原', 'success');
            }
        }
        function hardDeleteUser(id) {
            hardDeleteTargetId = id;
            const btn = document.getElementById('btn-confirm-permanent');
            btn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
            btn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-700');
            btn.disabled = true;
            let count = 5;
            btn.textContent = `請稍候 (${count})`;
            document.getElementById('permanent-delete-modal').classList.remove('hidden');
            clearInterval(deleteTimer);
            deleteTimer = setInterval(() => { count--; if(count > 0) { btn.textContent = `請稍候 (${count})`; } else { clearInterval(deleteTimer); btn.textContent = "確認永久刪除"; btn.disabled = false; btn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed'); btn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700'); } }, 1000);
        }
        function confirmHardDelete() {
            if(!hardDeleteTargetId) return;
            state.users = state.users.filter(u => u.id !== hardDeleteTargetId);
            state.records = state.records.filter(r => r.userId !== hardDeleteTargetId);
            state.leaves = state.leaves.filter(l => l.userId !== hardDeleteTargetId);
            saveData(); closeModal('permanent-delete-modal'); renderOverview(true); showToast('資料已永久刪除', 'success');
        }

        // --- EMPLOYEE SETTINGS ---
        function getUserLeaveStats(userId) {
            const used = { '特休': 0, '補休': 0, '生日假': 0 };
            const records = [];
            state.leaves.forEach(l => {
                if(l.userId === userId && (l.status === 'approved' || l.status === 'pending') && used.hasOwnProperty(l.type)) {
                    used[l.type] += parseFloat(l.hours) || 0;
                    records.push({ type: l.type, start: l.start, hours: l.hours, status: l.status });
                }
            });
            return { used, records };
        }
        function openEmployeeSettings(userId) {
            state.settingTargetId = userId;
            const u = state.users.find(u => u.id === userId);
            if(!u) return;
            document.getElementById('setting-user-name').textContent = u.name;
            document.getElementById('setting-onboard-date').value = u.onboardDate || '';
            document.getElementById('setting-annual-hours').value = u.quota_annual || 0;
            document.getElementById('setting-birthday-hours').value = u.quota_birthday || 0;
            document.getElementById('setting-comp-hours').value = u.quota_comp || 0;
            const stats = getUserLeaveStats(userId);
            const previewContainer = document.getElementById('setting-stats-preview');
            const historyList = document.getElementById('setting-history-list');
            const totals = { '特休': u.quota_annual || 0, '補休': u.quota_comp || 0, '生日假': u.quota_birthday || 0 };
            previewContainer.innerHTML = Object.keys(totals).map(k => {
                const remaining = totals[k] - stats.used[k];
                const color = remaining > 0 ? 'text-green-600' : 'text-gray-400';
                return `<div class="bg-gray-50 p-2 rounded text-center border"><div class="text-xs text-gray-500">${k}</div><div class="font-bold ${color}">${remaining} <span class="text-xs text-gray-400">/ ${totals[k]}</span></div></div>`
            }).join('');
            if(stats.records.length === 0) { historyList.innerHTML = '<div class="text-gray-400 text-center py-2">無相關請假紀錄</div>'; } 
            else { 
                historyList.innerHTML = stats.records.map(r => {
                    const statusText = r.status === 'pending' ? '<span class="text-orange-500">(審核中)</span>' : '';
                    return `<div class="flex justify-between border-b py-1"><span>${r.start.split(' ')[0]}</span><span>${r.type} ${statusText}</span><span class="font-mono">${r.hours}h</span></div>`;
                }).join(''); 
            }
            document.getElementById('calc-result').textContent = '';
            document.getElementById('employee-settings-modal').classList.remove('hidden');
            if(u.onboardDate) updateAnnualLeaveCalc();
        }
        function saveEmployeeSettings() {
            const u = state.users.find(u => u.id === state.settingTargetId);
            if(u) {
                u.onboardDate = document.getElementById('setting-onboard-date').value;
                u.quota_annual = parseFloat(document.getElementById('setting-annual-hours').value) || 0;
                u.quota_birthday = parseFloat(document.getElementById('setting-birthday-hours').value) || 0;
                u.quota_comp = parseFloat(document.getElementById('setting-comp-hours').value) || 0;
                saveData();
                showToast('設定已儲存', 'success');
                closeModal('employee-settings-modal');
            }
        }
        function renderEmpQuotaStats() {
            const u = state.currentUser;
            if (!u || u.role !== 'employee') return;
            const used = { '特休': 0, '補休': 0, '生日假': 0 };
            state.leaves.forEach(l => {
                if (l.userId === u.id && (l.status === 'approved' || l.status === 'pending') && used.hasOwnProperty(l.type)) {
                    used[l.type] += parseFloat(l.hours) || 0;
                }
            });
            const total = {
                '特休': u.quota_annual || 0,
                '補休': u.quota_comp || 0,
                '生日假': u.quota_birthday || 0
            };
            const html = Object.keys(total).map(type => {
                const left = total[type] - used[type];
                const colorClass = left > 0 ? 'text-green-600' : 'text-gray-400';
                return `<div class="bg-gray-50 rounded-lg p-2 text-center border border-gray-100"><div class="text-xs text-gray-500 font-bold mb-1">${type}</div><div class="text-sm font-bold ${colorClass}">${left} <span class="text-xs text-gray-400">/ ${total[type]}h</span></div></div>`;
            }).join('');
            const container = document.getElementById('emp-quota-stats');
            if(container) container.innerHTML = html;
        }

        // --- CALCULATIONS ---
        function calculateAnnualLeave(onboardDateStr) {
            if (!onboardDateStr) return 0;
            const onboard = new Date(onboardDateStr);
            const today = new Date();
            const diffTime = Math.abs(today - onboard);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            const years = diffDays / 365.25;
            let days = 0;
            if (years >= 0.5 && years < 1) days = 3;
            else if (years >= 1 && years < 2) days = 7;
            else if (years >= 2 && years < 3) days = 10;
            else if (years >= 3 && years < 5) days = 14;
            else if (years >= 5 && years < 10) days = 15;
            else if (years >= 10) days = 15 + Math.min(Math.floor(years - 10), 15); 
            return { days, hours: days * 8, seniorityYears: Math.floor(years), seniorityMonths: Math.floor((years % 1) * 12) };
        }
        function updateAnnualLeaveCalc() {
            const dateStr = document.getElementById('setting-onboard-date').value;
            const res = calculateAnnualLeave(dateStr);
            const text = dateStr ? `年資: ${res.seniorityYears}年${res.seniorityMonths}個月，依勞基法特休應為: ${res.days}天 (${res.hours}小時)` : '';
            document.getElementById('calc-result').textContent = text;
            if(dateStr) document.getElementById('setting-annual-hours').placeholder = `建議: ${res.hours}`;
        }
        function calculateLeaveHoursInternal(sD, sT, eD, eT) {
            if(!sD || !eD) return 0;
            const parseDate = (dStr, tStr) => { const [y, m, d] = dStr.split('-').map(Number); const [h, min] = tStr.split(':').map(Number); return new Date(y, m - 1, d, h, min); };
            let current = parseDate(sD, sT); const end = parseDate(eD, eT);
            if(current >= end) return 0;
            let totalHours = 0; let loop = new Date(current); loop.setHours(0,0,0,0); const endDay = new Date(end); endDay.setHours(0,0,0,0);
            while(loop <= endDay) {
                const y = loop.getFullYear(); const m = String(loop.getMonth() + 1).padStart(2, '0'); const d = String(loop.getDate()).padStart(2, '0'); const dayStr = `${y}-${m}-${d}`;
                const isHoliday = state.holidays.some(h => h.date === dayStr); const dayOfWeek = loop.getDay();
                if(!isHoliday && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    let w1S = new Date(loop.getFullYear(), loop.getMonth(), loop.getDate(), 8, 30); let w1E = new Date(loop.getFullYear(), loop.getMonth(), loop.getDate(), 12, 0);
                    let w2S = new Date(loop.getFullYear(), loop.getMonth(), loop.getDate(), 13, 0); let w2E = new Date(loop.getFullYear(), loop.getMonth(), loop.getDate(), 17, 30);
                    let start1 = current > w1S ? current : w1S; let end1 = end < w1E ? end : w1E; if(start1 < end1) totalHours += (end1 - start1);
                    let start2 = current > w2S ? current : w2S; let end2 = end < w2E ? end : w2E; if(start2 < end2) totalHours += (end2 - start2);
                }
                loop.setDate(loop.getDate() + 1);
            }
            return (totalHours / 36e5).toFixed(1);
        }
        function calcLeavePreview() {
            // Guard clause: if user not logged in or dashboard hidden, skip
            if (!state.currentUser) return;
            
            const sD = document.getElementById('leave-start-date').value; const eD = document.getElementById('leave-end-date').value; const sT = document.getElementById('leave-start-time').value; const eT = document.getElementById('leave-end-time').value;
            const btn = document.getElementById('leave-submit-btn');
            const errMsg = document.getElementById('leave-error-msg');
            const type = document.getElementById('leave-type').value;
            
            // 1. Time Validation
            let isValidTime = true;
            if(sD && eD && (eD < sD || (eD === sD && eT <= sT))) {
                isValidTime = false;
                errMsg.textContent = "結束時間不能早於開始時間";
                errMsg.classList.remove('hidden');
            } else {
                errMsg.classList.add('hidden');
            }

            // 2. Quota Validation
            let isValidQuota = true;
            const hours = parseFloat(calculateLeaveHoursInternal(sD, sT, eD, eT));
            if (isValidTime && (type === '特休' || type === '補休' || type === '生日假')) {
                const u = state.currentUser;
                const used = state.leaves.filter(l => l.userId === u.id && (l.status === 'approved' || l.status === 'pending') && l.type === type).reduce((sum, l) => sum + (parseFloat(l.hours) || 0), 0);
                let total = 0;
                if(type === '特休') total = u.quota_annual || 0;
                if(type === '補休') total = u.quota_comp || 0;
                if(type === '生日假') total = u.quota_birthday || 0;
                const remaining = total - used;
                if (remaining <= 0) {
                    isValidQuota = false;
                    errMsg.textContent = `無剩餘${type}額度`;
                    errMsg.classList.remove('hidden');
                } else if (hours > remaining) {
                    isValidQuota = false;
                    errMsg.textContent = `${type}額度不足 (剩餘 ${remaining}h)`;
                    errMsg.classList.remove('hidden');
                }
            }

            if (isValidTime && isValidQuota) {
                btn.disabled = false;
                btn.classList.remove('btn-disabled');
                btn.textContent = "送出申請";
            } else {
                btn.disabled = true;
                btn.classList.add('btn-disabled');
                if(btn.textContent === "送出申請") btn.textContent = "無法申請";
            }

            document.getElementById('preview-type').textContent = type; 
            document.getElementById('preview-range').textContent = `${sD} ${sT} ~ ${eD} ${eT}`;
            document.getElementById('preview-hours').textContent = `${hours} 小時`;
        }
        function handleLeaveSubmit(e) {
            e.preventDefault();
            const type = document.getElementById('leave-type').value === '其他' ? document.getElementById('leave-type-other').value : document.getElementById('leave-type').value;
            state.leaves.unshift({ id: Date.now(), userId: state.currentUser.id, user: state.currentUser.name, type, start: `${document.getElementById('leave-start-date').value} ${document.getElementById('leave-start-time').value}`, end: `${document.getElementById('leave-end-date').value} ${document.getElementById('leave-end-time').value}`, hours: document.getElementById('preview-hours').textContent.replace(' 小時',''), reason: document.getElementById('leave-reason').value, status: 'pending', created_at: new Date().toLocaleString(), rejectReason: '' });
            saveData(); renderLeavePreview(); showToast('申請已送出', 'success'); e.target.reset(); calcLeavePreview(); renderEmpQuotaStats();
        }

        // --- ADMIN FUNCTIONS ---
        function switchAdminTab(tab) {
            state.currentView = tab; saveSession();
            document.querySelectorAll('.admin-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`admin-view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            if(tab === 'overview') {
                renderOverview(false);
                const btn = document.getElementById('btn-toggle-deleted');
                if(btn) {
                    btn.classList.remove('bg-red-200', 'text-red-800');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                    btn.innerHTML = '<i class="fas fa-trash-restore mr-1"></i> 查看已刪除';
                }
            }
            if(tab === 'leaves') renderAdminLeaves();
            if(tab === 'announcements') renderAdminAnnouncements();
            if(tab === 'holidays') renderHolidays();
        }

        function renderOverview(showDeleted = false) {
            const todayStr = getLocalISOString();
            const tbody = document.getElementById('admin-records-body');
            let empUsers = state.users.filter(u => u.role !== 'admin');
            if (showDeleted) { empUsers = empUsers.filter(u => u.deleted); } else { empUsers = empUsers.filter(u => !u.deleted); }
            
            if (empUsers.length === 0) {
                const msg = showDeleted ? '無已刪除員工' : '暫無員工資料';
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400">${msg}</td></tr>`;
                return;
            }

            tbody.innerHTML = empUsers.map(u => {
                if (showDeleted) {
                    return `<tr class="hover:bg-red-50 border-b bg-red-50/50"><td class="p-4 font-mono text-gray-500 whitespace-nowrap">${u.id}</td><td class="p-4 font-bold text-gray-500 whitespace-nowrap">${u.name} (已封存)</td><td class="p-4 text-gray-400 whitespace-nowrap">${u.dept || '-'}</td><td class="p-4 text-gray-400 whitespace-nowrap text-sm" colspan="3">--</td><td class="p-4 flex gap-2 whitespace-nowrap"><button onclick="restoreUser('${u.id}')" class="text-green-600 hover:text-green-800 font-bold text-sm border border-green-200 px-2 py-1 rounded bg-white"><i class="fas fa-trash-restore mr-1"></i>還原</button><button onclick="hardDeleteUser('${u.id}')" class="text-red-600 hover:text-red-800 font-bold text-sm border border-red-200 px-2 py-1 rounded bg-white"><i class="fas fa-ban mr-1"></i>永久刪除</button></td></tr>`;
                }
                const userRecords = state.records.filter(r => r.userId === u.id && r.date === todayStr);
                const inRecords = userRecords.filter(r => r.type === 'in').sort((a,b) => a.time.localeCompare(b.time));
                const outRecords = userRecords.filter(r => r.type === 'out').sort((a,b) => a.time.localeCompare(b.time));
                const earliestInRec = inRecords.length > 0 ? inRecords[0] : null;
                const latestOutRec = outRecords.length > 0 ? outRecords[outRecords.length - 1] : null;
                
                const earliestIn = earliestInRec ? `<div>${earliestInRec.date}<br>${earliestInRec.time}</div>${earliestInRec.lat ? `<div class="text-xs text-gray-400">(${earliestInRec.lat.toFixed(4)},${earliestInRec.lng.toFixed(4)})</div>` : ''}` : '--';
                const latestOut = latestOutRec ? `<div>${latestOutRec.date}<br>${latestOutRec.time}</div>${latestOutRec.lat ? `<div class="text-xs text-gray-400">(${latestOutRec.lat.toFixed(4)},${latestOutRec.lng.toFixed(4)})</div>` : ''}` : '--';

                let abnormalFlag = '';
                let recordCoords = ''; 
                if(latestOutRec) {
                     if (latestOutRec.lat && latestOutRec.lng) {
                         const verifyDist = getDistanceFromLatLonInM(latestOutRec.lat, latestOutRec.lng, state.settings.lat, state.settings.lng);
                         if(verifyDist > state.settings.radius) {
                             abnormalFlag = `<span class="text-red-500 text-xs font-bold block">位置異常 (${parseInt(verifyDist)}m)</span>`;
                         }
                     }
                }
                
                let timeWarning = '';
                if (earliestInRec && earliestInRec.time < '08:00:00') timeWarning += `<span class="text-orange-600 text-xs font-bold block">早到 (提早30分以上)</span>`;
                if (latestOutRec && latestOutRec.time > '18:00:00') timeWarning += `<span class="text-orange-600 text-xs font-bold block">晚退 (加班?)</span>`;
                
                const dayOfWeek = new Date().getDay();
                const isHoliday = state.holidays.some(h => h.date === todayStr) || dayOfWeek === 0 || dayOfWeek === 6;
                let holidayWarning = '';
                if (isHoliday && (userRecords.length > 0)) holidayWarning = `<span class="text-purple-600 text-xs font-bold block">假日出勤</span>`;

                const approvedLeave = state.leaves.find(l => l.userId === u.id && l.status === 'approved' && l.start.includes(todayStr));
                let status = '未到班', badgeClass = 'status-absent';
                
                if (approvedLeave && userRecords.length > 0) {
                     status = '休假中打卡 (異常)'; 
                     badgeClass = 'bg-red-100 text-red-800';
                }
                else if (approvedLeave) { status = '休假'; badgeClass = 'status-leave'; }
                else if (earliestInRec) {
                    if (!latestOutRec) { status = '上班中'; badgeClass = 'status-working'; }
                    else {
                         if(latestOutRec.time < '17:30:00') { status = '早退'; badgeClass = 'status-early'; }
                         else { status = '下班'; badgeClass = 'status-off'; }
                    }
                }
                
                return `<tr class="hover:bg-gray-50 border-b"><td class="p-4 font-mono text-gray-600 whitespace-nowrap">${u.id}</td><td class="p-4 font-bold whitespace-nowrap">${u.name}</td><td class="p-4 text-gray-500 whitespace-nowrap">${u.dept || '-'}</td><td class="p-4 font-mono text-sm whitespace-nowrap">${earliestIn}</td><td class="p-4 font-mono text-sm whitespace-nowrap">${latestOut}${abnormalFlag}${recordCoords}</td><td class="p-4 whitespace-nowrap"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${status}</span>${timeWarning}${holidayWarning}</td><td class="p-4 flex gap-2 whitespace-nowrap"><button onclick="openEmployeeSettings('${u.id}')" class="text-gray-500 hover:text-gray-700 p-1" title="員工設定"><i class="fas fa-cog"></i></button><button onclick="openChangePasswordModal('${u.id}')" class="text-blue-500 hover:text-blue-700 p-1" title="修改密碼"><i class="fas fa-key"></i></button><button onclick="deleteUser('${u.id}')" class="text-red-500 hover:text-red-700 p-1" title="封存員工"><i class="fas fa-trash-alt"></i></button></td></tr>`;
            }).join('');
        }
        function renderAdminLeaves() {
            const pending = state.leaves.filter(l => l.status === 'pending');
            const filterDate = document.getElementById('admin-leave-filter-date').value;
            let history = state.leaves.filter(l => l.status !== 'pending' && l.status !== 'cancelled');
            
            if (filterDate) {
                history = history.filter(l => {
                    const start = l.start.split(' ')[0];
                    const end = l.end.split(' ')[0];
                    return filterDate >= start && filterDate <= end;
                });
            }

            const totalPages = Math.ceil(pending.length / ITEMS_PER_PAGE);
            if (state.adminLeavePage > totalPages) state.adminLeavePage = Math.max(1, totalPages);
            const startIdx = (state.adminLeavePage - 1) * ITEMS_PER_PAGE;
            const pagedPending = pending.slice(startIdx, startIdx + ITEMS_PER_PAGE);
            document.getElementById('admin-sidebar-pending-count').textContent = pending.length;
            document.getElementById('admin-sidebar-pending-count').classList.toggle('hidden', pending.length===0);
            document.getElementById('admin-page-indicator').textContent = `${state.adminLeavePage} / ${totalPages || 1}`;
            document.getElementById('admin-pending-list').innerHTML = pagedPending.length ? pagedPending.map(l => `
                <div class="p-4 border rounded bg-white shadow-sm">
                    <div class="flex justify-between font-bold"><span>${l.userId} (${l.user}) - ${l.type}</span><span>${l.hours}h</span></div>
                    <div class="text-sm text-gray-800 font-bold mt-1">請假時間：${l.start} ~ ${l.end}</div>
                    <div class="text-sm bg-gray-50 p-2 mt-2 rounded">事由: ${l.reason}</div>
                    <div class="mt-3 flex gap-2"><button onclick="approveLeave(${l.id})" class="flex-1 bg-green-500 text-white py-1 rounded text-sm">批准</button><button onclick="initReject(${l.id})" class="flex-1 bg-red-500 text-white py-1 rounded text-sm">拒絕</button></div>
                </div>`).join('') : '<div class="text-center text-gray-400 py-4">無待審核項目</div>';
            document.getElementById('admin-history-list').innerHTML = history.length ? history.map(l => `
                <div class="p-3 border rounded bg-gray-50 text-sm relative group">
                    <div class="flex justify-between items-center mb-1 pr-8"><div class="font-bold">${l.userId} (${l.user}) - <span class="text-xs font-normal bg-gray-200 px-1 rounded">${l.type}</span></div><span class="px-2 py-0.5 rounded text-xs ${l.status==='approved'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${l.status==='approved'?'審核通過':'被拒絕'}</span></div>
                    <div class="text-xs text-gray-600 mt-2 bg-white p-2 rounded border"><div>申請: ${cleanDateTime(l.created_at)}</div><div class="font-bold text-gray-800 my-1">請假時間: ${l.start} ~ ${l.end}</div><div>時數: ${l.hours}h</div><div class="text-gray-800 mt-1">事由: ${l.reason}</div>${l.status==='rejected'?`<div class="text-red-600 border-t pt-1 mt-1">拒絕原因: ${l.rejectReason}</div>`:''}</div>
                    <button onclick="deleteLeave(${l.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>`).join('') : '<div class="text-center text-gray-400 py-2">無符合紀錄</div>';
        }
        function approveLeave(id) { const l = state.leaves.find(x => x.id === id); if(l) { l.status = 'approved'; saveData(); renderAdminLeaves(); showToast('已批准'); } }
        function initReject(id) { state.pendingAction = { type: 'rejectLeave', id: id }; document.getElementById('reject-modal').classList.remove('hidden'); }
        function submitReject() { const reason = document.getElementById('reject-reason-input').value; const l = state.leaves.find(x => x.id === state.pendingAction.id); if(l && reason) { l.status = 'rejected'; l.rejectReason = reason; saveData(); renderAdminLeaves(); closeModal('reject-modal'); } }
        function deleteLeave(id) { initMathVerify(() => { state.leaves = state.leaves.filter(x => x.id !== id); saveData(); renderAdminLeaves(); showToast('已刪除'); }); }
        function handleAddAnnouncement(e){e.preventDefault(); const title=document.getElementById('announce-title').value; const cat=document.getElementById('announce-category').value; const content=document.getElementById('announce-content').innerHTML; state.announcements.unshift({id:Date.now(), title, category:cat, content, date:new Date().toISOString().split('T')[0]}); saveData(); document.getElementById('announce-title').value=''; document.getElementById('announce-content').innerHTML=''; renderAdminAnnouncements(); showToast('公告已發布','success');}
        function deleteAnnouncement(id){state.announcements = state.announcements.filter(a=>a.id!==id); saveData(); renderAdminAnnouncements();}
        function addHoliday(){ const date=document.getElementById('holiday-date').value; const note=document.getElementById('holiday-note').value; if(date){ state.holidays.push({id:Date.now(), date, note}); saveData(); document.getElementById('holiday-date').value=''; document.getElementById('holiday-note').value=''; renderHolidays(); recalculateAllLeaves(); showToast('假期已新增','success'); } else alert('請選擇日期'); }
        function deleteHoliday(id){state.holidays = state.holidays.filter(h=>h.id!==id); saveData(); renderHolidays(); recalculateAllLeaves();}
        function changeAdminPage(delta) { state.adminLeavePage += delta; renderAdminLeaves(); }
        function deleteUser(id) { if(confirm('確定要封存此員工帳號嗎？(可還原)')) { const u = state.users.find(u => u.id === id); if(u) u.deleted = true; saveData(); renderOverview(); showToast('員工已封存'); } }
        function generateAIReport() {const empUsers = state.users.filter(u => u.role !== 'admin');const total = empUsers.length;const todayStr = getLocalISOString();let presentCount = 0;empUsers.forEach(u => {if (state.records.some(r => r.userId === u.id && r.date === todayStr)) presentCount++;});const leaves = state.leaves.filter(l => l.start.includes(todayStr) && l.status === 'approved').length;document.getElementById('ai-report-content').innerHTML = `<b>[${todayStr} 人事摘要]</b><br>應到人數：${total} 人<br>實到人數：${presentCount} 人<br>請假人數：${leaves} 人<br>未到/異常：${total - presentCount - leaves} 人<br><span class="text-xs text-gray-400">報告生成時間：${new Date().toLocaleTimeString()}</span>`;}
        function renderAdminAnnouncements(){ document.getElementById('admin-announcement-list').innerHTML = state.announcements.length ? state.announcements.map(a => `<div class="bg-gray-50 p-3 rounded border relative group"><div class="font-bold text-sm flex items-center gap-2"><span class="px-2 py-0.5 rounded text-xs badge-${a.category}">${getCatLabel(a.category)}</span>${a.title}</div><div class="text-xs text-gray-500 mb-2">${cleanDate(a.date)}</div><div class="text-sm border-t pt-2">${a.content}</div><button onclick="deleteAnnouncement(${a.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>`).join('') : '<div class="text-center text-gray-400 text-sm">無公告</div>'; }
        function renderHolidays(){ document.getElementById('holiday-list').innerHTML = state.holidays.length ? state.holidays.map(h => `<div class="flex justify-between items-center bg-gray-50 p-3 rounded border mb-2"><div><span class="font-bold text-sm text-gray-700">${cleanDate(h.date)}</span><span class="text-sm text-gray-500 ml-2">(${h.note||'無備註'})</span></div><button onclick="deleteHoliday(${h.id})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`).join('') : '<div class="text-center text-gray-400 text-sm">無設定假期</div>'; }
        function toggleAllLeaves() { /* No longer needed but kept to avoid ref error */ }
        function openExportModal() {
            const today = getLocalISOString();
            document.getElementById('export-start-date').value = today;
            document.getElementById('export-end-date').value = today;
            document.getElementById('export-modal').classList.remove('hidden');
        }
        function performExport() {
            const start = document.getElementById('export-start-date').value;
            const end = document.getElementById('export-end-date').value;
            if(!start || !end) { alert('請選擇完整的日期區間'); return; }
            if(start > end) { alert('開始日期不能晚於結束日期'); return; }
            const exportData = state.records.filter(r => r.date >= start && r.date <= end);
            if(exportData.length === 0) { alert('該區間內無打卡紀錄'); return; }
            let csvContent = "\uFEFF";
            csvContent += "日期,時間,員工帳號,員工姓名,類型,緯度,經度,距離公司(m),狀態異常標記\n";
            exportData.sort((a, b) => (b.date + b.time).localeCompare(a.date + a.time));
            exportData.forEach(r => {
                const user = state.users.find(u => u.id === r.userId);
                const name = user ? user.name : 'Unknown';
                const typeLabel = r.type === 'in' ? '上班' : '下班';
                let statusNotes = [];
                let dist = 0;
                if (r.lat && r.lng) {
                    dist = getDistanceFromLatLonInM(r.lat, r.lng, state.settings.lat, state.settings.lng);
                    if (dist > state.settings.radius) statusNotes.push(`位置異常(${parseInt(dist)}m)`);
                } else { statusNotes.push("無座標數據"); }
                if (r.type === 'in' && r.time < '08:00:00') statusNotes.push("早到(>30分)");
                if (r.type === 'out' && r.time > '18:00:00') statusNotes.push("晚退(加班?)");
                if (r.type === 'in' && r.time > '08:30:00') statusNotes.push("遲到");
                if (r.type === 'out' && r.time < '17:30:00') statusNotes.push("早退");
                const statusStr = statusNotes.length > 0 ? statusNotes.join('; ') : '正常';
                const latStr = r.lat ? r.lat.toFixed(6) : '';
                const lngStr = r.lng ? r.lng.toFixed(6) : '';
                csvContent += `${r.date},${r.time},${r.userId},${name},${typeLabel},${latStr},${lngStr},${parseInt(dist)},"${statusStr}"\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `打卡紀錄_${start}_${end}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            closeModal('export-modal');
            showToast(`已匯出 ${exportData.length} 筆紀錄`, 'success');
        }
        function openLeaveExportModal() {
            const today = getLocalISOString();
            document.getElementById('leave-export-start-date').value = today;
            document.getElementById('leave-export-end-date').value = today;
            document.getElementById('leave-export-modal').classList.remove('hidden');
        }
        function performLeaveExport() {
            const start = document.getElementById('leave-export-start-date').value;
            const end = document.getElementById('leave-export-end-date').value;
            if(!start || !end) { alert('請選擇完整的日期區間'); return; }
            if(start > end) { alert('開始日期不能晚於結束日期'); return; }
            const exportData = state.leaves.filter(l => {
                const lStart = l.start.split(' ')[0];
                return lStart >= start && lStart <= end && l.status !== 'pending' && l.status !== 'cancelled';
            });
            if(exportData.length === 0) { alert('該區間內無已審核請假紀錄'); return; }
            let csvContent = "\uFEFF";
            csvContent += "申請日期,員工帳號,員工姓名,假別,開始時間,結束時間,時數,事由,狀態,拒絕原因\n";
            exportData.sort((a, b) => b.created_at.localeCompare(a.created_at));
            exportData.forEach(l => {
                const user = state.users.find(u => u.id === l.userId);
                const name = user ? user.name : 'Unknown';
                const statusLabel = l.status === 'approved' ? '已批准' : '被拒絕';
                const rejectReason = l.rejectReason ? String(l.rejectReason).replace(/,/g, ' ') : '';
                const reason = l.reason ? String(l.reason).replace(/,/g, ' ') : '';
                csvContent += `${cleanDateTime(l.created_at)},${l.userId},${name},${l.type},${l.start},${l.end},${l.hours},"${reason}",${statusLabel},"${rejectReason}"\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `請假紀錄_${start}_${end}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            closeModal('leave-export-modal');
            showToast(`已匯出 ${exportData.length} 筆請假紀錄`, 'success');
        }
        function exportSingleEmployeeLeaves(userId) {
            const user = state.users.find(u => u.id === userId);
            if (!user) return;
            const userLeaves = state.leaves.filter(l => l.userId === userId);
            if (userLeaves.length === 0) { alert('該員工無請假紀錄'); return; }
            let csvContent = "\uFEFF";
            csvContent += "申請日期,假別,開始時間,結束時間,時數,事由,狀態,拒絕原因\n";
            userLeaves.sort((a, b) => b.created_at.localeCompare(a.created_at));
            userLeaves.forEach(l => {
                const statusLabel = l.status === 'approved' ? '已批准' : (l.status === 'pending' ? '審核中' : (l.status === 'cancelled' ? '已取消' : '被拒絕'));
                const rejectReason = l.rejectReason ? String(l.rejectReason).replace(/,/g, ' ') : '';
                const reason = l.reason ? String(l.reason).replace(/,/g, ' ') : '';
                csvContent += `${cleanDateTime(l.created_at)},${l.type},${l.start},${l.end},${l.hours},"${reason}",${statusLabel},"${rejectReason}"\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${user.name}_請假紀錄.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast(`已匯出 ${user.name} 的請假紀錄`, 'success');
        }
        function initCancel(id) {
            initMathVerify(() => {
                const l = state.leaves.find(x => x.id === id);
                if (l) {
                    l.status = 'cancelled';
                    saveData();
                    renderLeavePreview();
                    renderLeaveHistoryModal();
                    showToast('已取消', 'success');
                }
            });
        }
        function openAddUserModal() { document.querySelectorAll('#add-user-modal input').forEach(i => i.value=''); document.getElementById('add-user-modal').classList.remove('hidden'); }
        function saveNewUser() {
            const id = document.getElementById('new-user-id').value.toLowerCase().trim();
            const pass = document.getElementById('new-user-pass').value;
            const name = document.getElementById('new-user-name').value;
            const dept = document.getElementById('new-user-dept').value;
            if(!id || !pass || !name) { alert('請填寫完整資訊'); return; }
            if(state.users.some(u => u.id.toLowerCase() === id)) { alert('帳號已存在！'); return; }
            state.users.push({ id, pass, name, role: 'employee', dept, deleted: false, 
                quota_annual: 0, quota_birthday: 0, quota_comp: 0
            });
            saveData(); renderOverview(); closeModal('add-user-modal'); showToast('員工新增成功', 'success');
        }

        // --- LIFECYCLE ---
        function resetIdleTimer() {
            if (idleTimer) clearTimeout(idleTimer);
            if (state.currentUser) idleTimer = setTimeout(() => { alert("閒置超過 5 分鐘，已自動登出"); logout(); }, IDLE_TIMEOUT);
        }
        function setupIdleListeners() {
            ['mousemove', 'keydown', 'click', 'scroll'].forEach(evt => document.addEventListener(evt, resetIdleTimer));
            resetIdleTimer();
        }
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });
            const dateStr = getFullDateString(now);
            const empTime = document.getElementById('emp-time');
            if(empTime) { empTime.textContent = timeStr; document.getElementById('emp-date-full').textContent = dateStr; }
            const adminDate = document.getElementById('admin-date-full');
            const adminTime = document.getElementById('admin-time-full');
            if(adminDate) { adminDate.textContent = dateStr; }
            if(adminTime) { adminTime.textContent = timeStr; }
        }
        function populateTimeSelects() {
            let opts = '';
            for(let t=8*60+30; t<=17*60+30; t+=30) {
                let h = Math.floor(t/60).toString().padStart(2,'0');
                let m = (t%60).toString().padStart(2,'0');
                opts += `<option value="${h}:${m}">${h}:${m}</option>`;
            }
            const s = document.getElementById('leave-start-time');
            const e = document.getElementById('leave-end-time');
            if(s && e) { s.innerHTML = opts; e.innerHTML = opts; e.value = "17:30"; }
        }
        function toggleOtherInput() {
            const val = document.getElementById('leave-type').value;
            const inp = document.getElementById('leave-type-other');
            val === '其他' ? inp.classList.remove('hidden') : inp.classList.add('hidden');
            calcLeavePreview();
        }

        async function init() {
            try {
                await loadData();
            } catch (err) {
                console.error("Initialization data load failed", err);
            }
            
            const session = loadSession();
            
            // Auto fill remembered username
            const savedUser = localStorage.getItem('saved_username');
            if(savedUser && document.getElementById('username')) {
                document.getElementById('username').value = savedUser;
                document.getElementById('remember-me').checked = true;
            }

            // Check Auto Login
            const autoAuth = JSON.parse(localStorage.getItem('auth_auto_login'));
            let autoLoggedIn = false;
            if (autoAuth && autoAuth.expiry > Date.now()) {
                const user = state.users.find(u => u.id === autoAuth.id && u.pass === autoAuth.pass && !u.deleted);
                if (user) {
                    performLogin(user, 'overview');
                    autoLoggedIn = true;
                }
            }

            if (!autoLoggedIn && session) performLogin(session.user, session.view);
            updateClock();
            setInterval(updateClock, 1000);
            populateTimeSelects();
            renderLoginAnnouncements();
            const today = getLocalISOString(); 
            const sEl = document.getElementById('leave-start-date');
            const eEl = document.getElementById('leave-end-date');
            if(sEl && eEl) { sEl.value=today; eEl.value=today; setTimeout(calcLeavePreview, 100); }
        }

        init();
    </script>
</body>
</html>
