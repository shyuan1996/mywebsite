
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 輔助函式：檢查是否為管理員
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/admin) &&
             get(/databases/$(database)/documents/users/admin).data.uid == request.auth.uid;
    }

    // 輔助函式：檢查資料中的 uid 是否與當前登入者相符 (嚴格身分驗證)
    // 注意：這裡檢查的是 'uid' (Firebase ID) 而不是 'userId' (員工帳號字串)
    function isDataOwner() {
      return request.resource.data.uid == request.auth.uid;
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if request.auth != null;
      
      // 建立規則: 綁定 UID
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;

      // 更新規則:
      // 1. 管理員可全權修改
      // 2. 用戶本人僅可更新 uid (綁定用) 或 pass (密碼標記)
      allow update: if isAdmin() || (
        request.auth != null && 
        request.auth.uid == request.resource.data.uid && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['uid', 'pass'])
      );

      allow delete: if isAdmin();
    }

    // --- Records (打卡紀錄) ---
    match /records/{recordId} {
      // 管理員可讀所有；員工只能讀自己的 (這裡可以用 userId 因為前端查詢是用 userId)
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid); // 若要嚴格可改 resource.data.uid
      
      // 寫入驗證：必須包含正確的 uid 欄位
      allow create: if request.auth != null && isDataOwner();
      
      allow update, delete: if isAdmin();
    }

    // --- Leaves (請假申請) ---
    match /leaves/{leaveId} {
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid); // 前端查詢相容性
      
      allow create: if request.auth != null && isDataOwner();
      
      // 員工只能更新 status (例如取消) 且必須是本人
      allow update: if isAdmin() || (
        request.auth != null && 
        resource.data.uid == request.auth.uid && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
      );
      
      allow delete: if isAdmin();
    }

    // --- Overtimes (加班申請) ---
    match /overtimes/{otId} {
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      
      allow create: if request.auth != null && isDataOwner();
      
      allow update: if isAdmin() || (
        request.auth != null && 
        resource.data.uid == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
      );
      
      allow delete: if isAdmin();
    }

    // --- Announcements (公告) ---
    match /announcements/{annId} {
      allow read: if true; 
      allow write: if isAdmin();
    }

    // --- Holidays (假期) ---
    match /holidays/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- System Settings ---
    match /system/settings {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
