<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報價單 - 祥鉞餐飲設備股份有限公司</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 字型設定 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }

        /* 隱藏日期選擇器的預設圖示 */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }

        /* 列印樣式優化 */
        @media print {
            @page { 
                size: A4 portrait; 
                /* 上 右 下 左 - 底部設為 0mm 以最小化間距 */
                margin: 8mm 8mm 0mm 8mm; 
            }
            body { 
                margin: 0; 
                padding: 0; 
                background-color: white; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
            
            /* 隱藏非列印元素 */
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; }
            .print\:text-white { color: white !important; } 
            .print\:flex-grow-0 { flex-grow: 0 !important; }
            .print\:pb-0 { padding-bottom: 0 !important; } /* 強制移除底部 padding */
            
            /* A4 容器設定 */
            .print-container {
                width: 100%; 
                max-width: 210mm; 
                min-height: auto; 
                padding: 0; 
                margin: 0 auto;
                box-shadow: none !important;
                border: none !important;
                overflow: visible;
                display: block; 
            }

            /* 輸入框列印樣式 */
            input, textarea { 
                background: transparent !important; 
                resize: none !important; 
                padding: 0 !important;
                color: inherit !important;
            }
            input::placeholder, textarea::placeholder { color: transparent; }
            
            /* 防止分頁切斷內容 */
            .page-break-inside-avoid { page-break-inside: avoid; }
            tr { page-break-inside: avoid; }

            /* 確保簽名欄跟隨內容，但儘量不被切斷 */
            .signature-section {
                page-break-inside: avoid;
                margin-top: 2rem; /* 與上方保持距離 */
            }
        }

        /* 螢幕顯示樣式 */
        @media screen {
            .print-container {
                width: 210mm;
                min-height: 297mm;
                padding: 8mm; 
                margin: 20px auto;
                background: white;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                display: flex;
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- Helper: Format Currency ---
        const formatCurrency = (num) => {
            if (isNaN(num)) return "NT$ 0";
            return "NT$ " + new Intl.NumberFormat('en-US', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(num);
        };

        // --- 圖示組件 ---
        const IconWrapper = ({ children, size = 18, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Save = (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
        const Printer = (props) => <IconWrapper {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconWrapper>;
        const Plus = (props) => <IconWrapper {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>;
        const Image = (props) => <IconWrapper {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconWrapper>;
        const Stamp = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M12 6v12"/><path d="M6 12h12"/></IconWrapper>;

        // --- 可編輯的金額組件 ---
        const EditableCurrency = ({ value, onChange, placeholder, prefix }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempValue, setTempValue] = useState(value);

            useEffect(() => { setTempValue(value); }, [value]);

            const handleBlur = () => {
                setIsEditing(false);
                onChange(parseFloat(tempValue) || 0);
            };

            const handleKeyDown = (e) => {
                 if(e.key === 'Enter') handleBlur();
            };

            return (
                <div className="w-full text-right" onClick={() => setIsEditing(true)}>
                    {isEditing ? (
                        <input 
                            autoFocus
                            type="number"
                            className="w-full text-right outline-none bg-transparent p-0 m-0"
                            value={tempValue}
                            onChange={(e) => setTempValue(e.target.value)}
                            onBlur={handleBlur}
                            onKeyDown={handleKeyDown}
                            placeholder={placeholder}
                        />
                    ) : (
                        <span className="cursor-text hover:bg-gray-50 block w-full rounded px-1 -mr-1">
                            {prefix}{formatCurrency(value)}
                        </span>
                    )}
                </div>
            );
        };

        // --- 自動調整高度的 Textarea 組件 ---
        const AutoHeightTextarea = ({ value, onChange, placeholder, className, rows = 1, style }) => {
            const textareaRef = useRef(null);

            useLayoutEffect(() => {
                if (textareaRef.current) {
                    textareaRef.current.style.height = 'auto';
                    textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
                }
            }, [value]);

            return (
                <textarea
                    ref={textareaRef}
                    className={className}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    rows={rows}
                    style={{ ...style, resize: 'none', overflow: 'hidden' }}
                />
            );
        };

        const QuotationGenerator = () => {
            const [toastMsg, setToastMsg] = useState('');
            
            // --- 狀態設定 ---
            const [themeColor, setThemeColor] = useState('#000000'); 
            const [logo, setLogo] = useState(null); 
            const [seal, setSeal] = useState(null);
            const [extraNote, setExtraNote] = useState(''); 
            
            // 備註與條款預設值
            const defaultNotes = "1. 本報價單有效期限為 14 天。\r\n2. 確定訂購請簽名回傳。\r\n3. 產品規格若有變更，以實際出貨為主。\r\n4. 付款方式：匯款 / 支票 / 現金。";
            const [notes, setNotes] = useState(defaultNotes);

            // 優惠相關
            const [discount, setDiscount] = useState(0);
            const [showDiscount, setShowDiscount] = useState(false);

            // 業務人員狀態
            const [salesPerson, setSalesPerson] = useState('簡呈光 0923-866-222');

            // 公司資料
            const [companyInfo, setCompanyInfo] = useState({
                name: '祥鉞餐飲設備股份有限公司',
                address: '406台中市北屯區水景街8號',
                phone: '04-2436-5774',
                fax: '04-2437-4738',
                email: 'sy.shyuan950101@shyuan.com.tw',
                taxId: '89872485', 
            });

            // 客戶資料
            const [clientInfo, setClientInfo] = useState({
                name: '客戶公司名稱',
                contact: '採購負責人', 
                address: '客戶地址',
                phone: '客戶電話',
            });

            // 報價單資訊
            const [quoteDetails, setQuoteDetails] = useState({
                number: `Q-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}001`,
                date: new Date().toISOString().split('T')[0],
                taxRate: 5,
            });

            // 報價項目
            const [items, setItems] = useState([
                { id: 1, name: '不鏽鋼工作台', spec: '120x60x80cm, SUS304', description: null, quantity: 1, price: 8500 },
                { id: 2, name: '四門冰箱', spec: '管冷, 上凍下藏', description: null, quantity: 1, price: 28000 },
            ]);

            // --- LocalStorage ---
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem('quotation_full_data_v13'); // Version 13
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        setCompanyInfo(parsed.companyInfo || companyInfo);
                        setThemeColor(parsed.themeColor || '#000000');
                        setLogo(parsed.logo || null);
                        setSeal(parsed.seal || null);
                        setExtraNote(parsed.extraNote || '');
                        setNotes(parsed.notes || defaultNotes); // Load notes
                        if (parsed.salesPerson) setSalesPerson(parsed.salesPerson); 
                        if (parsed.items) setItems(parsed.items);
                        if (parsed.clientInfo) setClientInfo(parsed.clientInfo); 
                        if (parsed.quoteDetails) setQuoteDetails(parsed.quoteDetails); 
                        if (parsed.discount) {
                            setDiscount(parsed.discount);
                            setShowDiscount(true);
                        }
                    }
                } catch (e) { console.warn("LS read error", e); }
            }, []);

            const showToast = (msg) => {
                setToastMsg(msg);
                setTimeout(() => setToastMsg(''), 3000);
            };

            const saveData = () => {
                try {
                    const dataToSave = { 
                        companyInfo, 
                        themeColor, 
                        logo, 
                        seal, 
                        items,
                        clientInfo,
                        quoteDetails,
                        extraNote,
                        salesPerson,
                        discount: showDiscount ? discount : 0,
                        notes // Save notes
                    };
                    localStorage.setItem('quotation_full_data_v13', JSON.stringify(dataToSave));
                    showToast('頁面所有資料已儲存！');
                } catch (e) { showToast('儲存失敗'); }
            };

            // --- 功能函數 ---
            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setLogo(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSealUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setSeal(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            // 計算
            const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const taxableAmount = Math.max(0, subtotal - (showDiscount ? discount : 0));
            const taxAmount = Math.round(taxableAmount * (quoteDetails.taxRate / 100));
            const total = taxableAmount + taxAmount;

            // 項目操作
            const handleAddItem = () => setItems([...items, { id: Date.now(), name: '', spec: '', description: null, quantity: 1, price: 0 }]);
            const handleDeleteItem = (id) => setItems(items.filter(item => item.id !== id));
            const handleItemChange = (id, field, value) => setItems(items.map(item => item.id === id ? { ...item, [field]: value } : item));

            const toggleDiscount = () => {
                setShowDiscount(!showDiscount);
                if (showDiscount) setDiscount(0); // 關閉時歸零
            };

            const handlePrint = () => {
                const now = new Date();
                const rocYear = now.getFullYear() - 1911;
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const safeClientName = (clientInfo.name || '客戶').replace(/[<>:"/\\|?*]/g, '_'); 
                
                const newTitle = `${rocYear}${month}${day}_祥鉞不鏽鋼_${safeClientName}`;
                const originalTitle = document.title;

                document.title = newTitle;

                showToast('準備列印...');
                setTimeout(() => {
                    window.print();
                    setTimeout(() => { document.title = originalTitle; }, 1000); 
                }, 500);
            };

            return (
                <div className="min-h-screen pb-10 print:pb-0">
                    
                    {/* Toast */}
                    {toastMsg && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-50 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg print:hidden">{toastMsg}</div>}

                    {/* 控制列 */}
                    <div className="bg-white shadow-md p-3 sticky top-0 z-20 print:hidden mb-4 border-b">
                        <div className="max-w-[210mm] mx-auto flex flex-wrap justify-between items-center gap-3">
                            <h1 className="text-lg font-bold text-gray-700 flex items-center gap-2">
                                報價單系統
                            </h1>
                            
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded">
                                    <span className="text-xs text-gray-500">表頭顏色:</span>
                                    <input 
                                        type="color" 
                                        value={themeColor} 
                                        onChange={(e) => setThemeColor(e.target.value)}
                                        className="w-6 h-6 border-none cursor-pointer bg-transparent"
                                        title="更改表頭顏色"
                                    />
                                </div>

                                <button onClick={saveData} className="flex items-center gap-1 px-3 py-1.5 bg-gray-200 hover:bg-gray-300 rounded text-sm transition">
                                    <Save /> 儲存設定
                                </button>
                                <button onClick={handlePrint} className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition font-medium">
                                    <Printer /> 列印 / PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* A4 報價單容器 */}
                    <div className="print-container">
                        
                        {/* 頁眉區域 */}
                        <div className="flex justify-between items-start border-b-2 border-black pb-2 mb-2">
                            
                            {/* 左側：公司資料容器 */}
                            <div className="w-3/5 flex gap-4">
                                {/* Logo 上傳區 */}
                                <div className="shrink-0 pt-1">
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="hidden" id="logo-upload" />
                                    {logo ? (
                                        <div className="relative group">
                                            <img src={logo} alt="Company Logo" className="h-20 w-auto object-contain" />
                                            <label htmlFor="logo-upload" className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 cursor-pointer flex items-center justify-center transition">
                                                <span className="opacity-0 group-hover:opacity-100 bg-white px-2 py-1 text-xs rounded shadow">更換</span>
                                            </label>
                                        </div>
                                    ) : (
                                        <label htmlFor="logo-upload" className="flex flex-col items-center justify-center gap-1 text-gray-400 border border-dashed border-gray-300 w-24 h-20 rounded cursor-pointer hover:bg-gray-50 print:hidden">
                                            <Image size={20} /> <span className="text-xs">上傳 Logo</span>
                                        </label>
                                    )}
                                </div>

                                {/* 公司文字資料 */}
                                <div className="flex-grow">
                                    <input 
                                        className="text-2xl font-bold w-full mb-2 outline-none text-black" 
                                        value={companyInfo.name}
                                        onChange={(e) => setCompanyInfo({...companyInfo, name: e.target.value})}
                                    />
                                    
                                    <div className="text-sm text-gray-700 space-y-1">
                                        <div className="flex">
                                            <span className="w-12 font-medium shrink-0">地址:</span>
                                            <input className="flex-1 outline-none" value={companyInfo.address} onChange={(e) => setCompanyInfo({...companyInfo, address: e.target.value})} />
                                        </div>
                                        <div className="flex items-center flex-nowrap w-full">
                                            <div className="flex items-center shrink-0 mr-2">
                                                <span className="w-12 font-medium shrink-0">電話:</span>
                                                <input className="w-32 outline-none" value={companyInfo.phone} onChange={(e) => setCompanyInfo({...companyInfo, phone: e.target.value})} />
                                            </div>
                                            <div className="flex items-center flex-grow">
                                                <span className="w-12 font-medium shrink-0 text-right pr-1">傳真:</span>
                                                <input className="flex-1 min-w-[100px] outline-none" value={companyInfo.fax} onChange={(e) => setCompanyInfo({...companyInfo, fax: e.target.value})} />
                                            </div>
                                        </div>
                                        <div className="flex">
                                            <span className="w-12 font-medium shrink-0">信箱:</span>
                                            <input className="flex-1 outline-none" value={companyInfo.email} onChange={(e) => setCompanyInfo({...companyInfo, email: e.target.value})} />
                                        </div>
                                        <div className="flex">
                                            <span className="w-12 font-medium shrink-0">統編:</span>
                                            <input className="flex-1 outline-none" value={companyInfo.taxId} onChange={(e) => setCompanyInfo({...companyInfo, taxId: e.target.value})} placeholder="請輸入統一編號" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 右側：單據資訊 */}
                            <div className="w-2/5 text-right flex flex-col items-end">
                                <h2 className="text-5xl font-extrabold tracking-widest mb-4 text-black">報 價 單</h2>
                                <div className="text-sm space-y-1.5 w-full">
                                    <div className="flex justify-end items-center">
                                        <span className="font-bold text-gray-600 mr-2">單號:</span>
                                        <input className="text-right w-32 font-mono border-b border-gray-400 outline-none" 
                                            value={quoteDetails.number} onChange={(e) => setQuoteDetails({...quoteDetails, number: e.target.value})} />
                                    </div>
                                    <div className="flex justify-end items-center">
                                        <span className="font-bold text-gray-600 mr-2">日期:</span>
                                        <input 
                                            type="date" 
                                            className="text-right w-32 font-mono border-b border-gray-400 outline-none cursor-pointer" 
                                            value={quoteDetails.date} 
                                            onChange={(e) => setQuoteDetails({...quoteDetails, date: e.target.value})}
                                            onClick={(e) => {
                                                try {
                                                    if (e.target.showPicker) {
                                                        e.target.showPicker();
                                                    }
                                                } catch (error) {
                                                    console.log(error);
                                                }
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 客戶資料區 */}
                        <div className="p-0" style={{ marginTop: '1mm', marginBottom: '4mm' }}>
                            <div className="flex items-start gap-4">
                                <div className="w-1/4">
                                    <label className="text-[11px] text-gray-500 block">客戶名稱</label>
                                    <AutoHeightTextarea 
                                        className="w-full font-bold text-base outline-none bg-transparent" 
                                        value={clientInfo.name} 
                                        onChange={(e) => setClientInfo({...clientInfo, name: e.target.value})} 
                                    />
                                </div>
                                <div className="w-1/4">
                                    <label className="text-[11px] text-gray-500 block">電話</label>
                                    <input className="w-full text-sm outline-none" 
                                        value={clientInfo.phone} onChange={(e) => setClientInfo({...clientInfo, phone: e.target.value})} />
                                </div>
                                <div className="flex-grow">
                                    <label className="text-[11px] text-gray-500 block">地址</label>
                                    <input className="w-full text-sm outline-none" 
                                        value={clientInfo.address} onChange={(e) => setClientInfo({...clientInfo, address: e.target.value})} />
                                </div>
                            </div>
                        </div>

                        {/* 報價明細表格 */}
                        <div className="flex-grow mb-4 print:flex-grow-0">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="text-white print:text-white" style={{ backgroundColor: themeColor }}>
                                        <th className="p-1 w-[5%] text-center">#</th>
                                        <th className="p-1 w-[43%] text-left">品名</th>
                                        <th className="p-1 w-[20%] text-left">規格</th>
                                        <th className="p-1 w-[6%] text-center whitespace-nowrap">數量</th>
                                        <th className="p-1 w-[13%] text-center whitespace-nowrap">單價</th>
                                        <th className="p-1 w-[13%] text-center whitespace-nowrap">金額</th>
                                        <th className="p-1 w-[30px] print:hidden"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {items.map((item, index) => (
                                        <tr key={item.id} className="border-b border-gray-300 group hover:bg-gray-50 print:border-gray-300">
                                            <td className="p-1 text-center text-gray-500 align-top pt-2">{index + 1}</td>
                                            <td className="p-1 align-top relative group">
                                                <div className="flex items-center justify-between">
                                                    <input className="w-full font-bold outline-none mb-0" 
                                                        value={item.name} onChange={(e) => handleItemChange(item.id, 'name', e.target.value)} placeholder="項目名稱" />
                                                    {/* 詳細描述開關按鈕 */}
                                                    {(item.description === null || item.description === undefined) && (
                                                        <button 
                                                            tabIndex="-1"
                                                            onClick={() => handleItemChange(item.id, 'description', '')}
                                                            className="ml-2 text-xs text-blue-500 hover:text-blue-700 print:hidden whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity"
                                                            title="新增描述"
                                                        >
                                                            + 描述
                                                        </button>
                                                    )}
                                                </div>
                                                
                                                {/* 詳細描述欄位 */}
                                                {(item.description !== null && item.description !== undefined) && (
                                                    <div className="relative">
                                                        <AutoHeightTextarea 
                                                            className="w-full text-[13px] text-gray-500 outline-none block" 
                                                            value={item.description} 
                                                            onChange={(e) => handleItemChange(item.id, 'description', e.target.value)} 
                                                            placeholder="詳細描述..."
                                                        />
                                                        <button
                                                            tabIndex="-1" 
                                                            onClick={() => handleItemChange(item.id, 'description', null)}
                                                            className="absolute right-0 top-0 text-gray-300 hover:text-red-500 print:hidden"
                                                            title="移除描述欄位"
                                                        >
                                                            &times;
                                                        </button>
                                                    </div>
                                                )}
                                            </td>
                                            <td className="p-1 align-top pt-2">
                                                <AutoHeightTextarea 
                                                    className="w-full text-sm outline-none" 
                                                    value={item.spec} 
                                                    onChange={(e) => handleItemChange(item.id, 'spec', e.target.value)} 
                                                    placeholder=""
                                                />
                                            </td>
                                            <td className="p-1 text-center align-top pt-2 whitespace-nowrap">
                                                <input type="number" className="w-full text-center outline-none" 
                                                    value={item.quantity} onChange={(e) => handleItemChange(item.id, 'quantity', parseFloat(e.target.value) || 0)} />
                                            </td>
                                            {/* 單價 - 靠右 */}
                                            <td className="p-1 text-right align-top pt-2 whitespace-nowrap">
                                                <EditableCurrency 
                                                    value={item.price} 
                                                    onChange={(val) => handleItemChange(item.id, 'price', val)} 
                                                />
                                            </td>
                                            {/* 金額 - 靠右 */}
                                            <td className="p-1 text-right font-medium align-top pt-2 whitespace-nowrap">
                                                {formatCurrency(item.quantity * item.price)}
                                            </td>
                                            <td className="p-1 text-center align-top pt-2 print:hidden">
                                                <button onClick={() => handleDeleteItem(item.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                                    <Trash2 size={16} />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <button onClick={handleAddItem} className="mt-2 text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1 print:hidden">
                                <Plus size={16} /> 新增項目
                            </button>
                        </div>

                        {/* 底部區域：第一排（備註框 / 印章 / 金額計算） */}
                        <div className="flex justify-between items-start mb-6 page-break-inside-avoid gap-2"> 
                            
                            {/* 左側空白備註框 */}
                            <div className="flex-grow">
                                <div className="p-2 h-full"> 
                                    <textarea 
                                        className="w-full h-24 text-sm bg-transparent outline-none resize-none" 
                                        placeholder="備註..."
                                        value={extraNote}
                                        onChange={(e) => setExtraNote(e.target.value)}
                                    ></textarea>
                                </div>
                            </div>

                            {/* 中間：印章區 */}
                            <div className="w-48 shrink-0 flex flex-col items-center justify-center group relative h-32">
                                <input type="file" accept="image/*" onChange={handleSealUpload} className="hidden" id="seal-upload" />
                                {seal ? (
                                    <div className="relative pointer-events-auto h-full w-full flex items-center justify-center">
                                        <img src={seal} alt="Seal" className="max-h-full max-w-full object-contain opacity-80" />
                                        <label htmlFor="seal-upload" className="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 cursor-pointer flex items-center justify-center transition print:hidden">
                                            <span className="opacity-0 hover:opacity-100 bg-white px-2 py-1 text-xs rounded shadow">更換</span>
                                        </label>
                                    </div>
                                ) : (
                                    <label htmlFor="seal-upload" className="flex flex-col items-center justify-center gap-1 text-gray-300 border border-dashed border-gray-300 w-full h-full rounded cursor-pointer hover:bg-gray-50 print:hidden pointer-events-auto">
                                        <Stamp size={28} /> <span className="text-xs">上傳印章</span>
                                    </label>
                                )}
                            </div>

                            {/* 右側：金額計算 */}
                            <div className="w-[280px] shrink-0">
                                <div className="flex justify-between py-1 text-sm group relative">
                                    <span className="text-gray-600 flex items-center">
                                        銷售金額 (Subtotal)
                                        {/* 優惠按鈕 */}
                                        <button 
                                            onClick={toggleDiscount}
                                            className="ml-2 text-xs text-blue-500 hover:text-blue-700 print:hidden opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1"
                                            title="新增優惠"
                                        >
                                            <Plus size={12} /> 優惠
                                        </button>
                                    </span>
                                    <span>{formatCurrency(subtotal)}</span>
                                </div>

                                {/* 優惠欄位 */}
                                {showDiscount && (
                                    <div className="flex justify-between py-1 text-sm text-red-600">
                                        <span className="flex items-center gap-1">
                                            折扣 (Discount)
                                            <button 
                                                onClick={toggleDiscount}
                                                className="text-gray-400 hover:text-red-500 print:hidden"
                                                title="移除優惠"
                                            >
                                                &times;
                                            </button>
                                        </span>
                                        <div className="w-24">
                                            <EditableCurrency 
                                                value={discount} 
                                                onChange={(val) => setDiscount(val)} 
                                                placeholder="輸入折扣"
                                                prefix="- "
                                            />
                                        </div>
                                    </div>
                                )}

                                <div className="flex justify-between items-center py-1 text-sm">
                                    <span className="text-gray-600 flex items-center gap-1">
                                        營業稅 (Tax)
                                        <span className="bg-gray-100 px-1 rounded text-xs print:hidden">
                                            <input type="number" className="w-6 text-center bg-transparent outline-none" 
                                                value={quoteDetails.taxRate} onChange={(e) => setQuoteDetails({...quoteDetails, taxRate: parseFloat(e.target.value) || 0})} />%
                                        </span>
                                        <span className="hidden print:inline text-xs">({quoteDetails.taxRate}%)</span>
                                    </span>
                                    <span>{formatCurrency(taxAmount)}</span>
                                </div>
                                <div className="flex justify-between py-3 text-lg font-bold border-t-2 border-black mt-1 text-black">
                                    <span>總計 (Total)</span>
                                    <span>{formatCurrency(total)}</span>
                                </div>
                            </div>
                        </div>

                        {/* 底部區域：第二排（備註條款 / 簽名） */}
                        <div className="border-t-2 border-gray-200 pt-4 page-break-inside-avoid flex gap-8">
                            
                            {/* 左側：備註與條款 (6行) */}
                            <div className="flex-grow">
                                <h4 className="font-bold text-sm mb-2 text-gray-700">備註與條款:</h4>
                                <textarea 
                                    className="w-full text-sm text-gray-600 outline-none bg-transparent" 
                                    style={{ resize: 'none' }}
                                    rows={6} 
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                />
                            </div>

                            {/* 右側：簽名區 */}
                            <div className="w-64 shrink-0 flex flex-col justify-end gap-1"> 
                                {/* 上：客戶簽名 */}
                                <div className="flex flex-col justify-end h-24"> 
                                    <div className="border-t border-black pt-2 text-center text-sm">客戶簽名</div>
                                </div>
                                
                                {/* 下：業務人員 */}
                                <div>
                                    <div className="mb-1 font-bold text-lg tracking-wide text-center">
                                        <input 
                                            className="text-center w-full bg-transparent outline-none" 
                                            value={salesPerson} 
                                            onChange={(e) => setSalesPerson(e.target.value)} 
                                        />
                                    </div>
                                    <div className="border-t border-black pt-2 text-center text-sm">業務人員</div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuotationGenerator />);
    </script>
</body>
</html>